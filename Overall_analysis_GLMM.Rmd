---
title: "Overall_analysis_GLMM"
author: "Alma Steireif"
date: "`r Sys.Date()`"
output: 
  html_document:
      toc: TRUE
---

## 0.0. Description



## Hypotheses

*Q1: Do reference and restored sites exhibit differences in pollinator biodiversity?*

  **H0:**
  • no significant difference between reference and restored sites in pollinator biodiversity
  → pollinators are highly mobile and can easily colonize restored habitats, thereby achieving similar biodiversity and composition to reference sites.
  
  **H1:**
  • pollinator diversity is higher in reference sites compared to young restored sites
  → habitat complexity, trophic levels, vegetation structure, and resource availability, all take time to develop in restored sites


*Q2: Do traditional and automated methods yield different compositions of pollinators?*

  **H0:**
  • no significant differences in pollinator composition detected by traditional and automated methods
  → because all methods aim to capture a representative sample of the pollinator community.
  
  **H1:**
  • Traditional and automated methods yield different compositions of pollinators
  → due to inherent biases in sampling efficiency, taxonomy resolution, and target taxa, leading to discrepancies in the detection of certain pollinators.
  
*Q3: Can automated methods effectively detect biodiversity changes between reference and restored sites?*

  **H0:**
  • Automated methods do not effectively detect biodiversity changes between reference and restored sites
  → due to limitations in capturing the full spectrum of pollinator abundance and species richness, as well as potential challenges in achieving high taxonomic resolution.
  
  **H1:**
  • Automated methods can effectively detect biodiversity differences between reference and restored sites
  → machine learning algorithms can offer improved sensitivity and accuracy in detecting shifts in pollinator communities over time.

## 0. Setup    

### libraries    

```{r setup, include=FALSE}
library(tidyverse) 
library(vegan)  # For diversity indices
library(paletteer)  # For color palettes
library(RColorBrewer)  # For color palettes


library(performance)
library(easystats)

library(reshape2)
library(chron)  # for time data

library(patchwork) #for wrapping plots
library(Hmisc)  # correlation matrix
library(corrplot)  # plotting

library(factoextra) #install library for fviz_pca
library(DHARMa) #for residual plots
library(pscl) #for zero inflation test
```

### aesthetics

```{r custom colors}
#define custom colors for plotting
saturated_pal <- c(
  #reference sites
  "DES" = "#7F3B19FF",  
  "HLI" = "#FDB863FF",  
  "JEP" = "#E08214FF",  
  "STP" = "#B35806FF",
  "WUP" = "#FEE0B6FF",
  # restored sites
  "BUH" = "#93C6E1FF",  
  "KOT" = "#5F93ACFF",  
  "WDG" = "#2E627AFF",  
  "WED" = "#00344AFF"  
)

# bicolor palette
bicolor_pal <- c(
  "DES" = "darkorange",  
  "HLI" = "darkorange",  
  "JEP" = "darkorange",  
  "STP" = "darkorange",
  "WUP" = "darkorange",
  "BUH" = "steelblue",  
  "KOT" = "steelblue",  
  "WDG" = "steelblue",  
  "WED" = "steelblue" 
)

bicolor_bg <- c(
  "DES" = "lightyellow",  
  "HLI" = "lightyellow",  
  "JEP" = "lightyellow",  
  "STP" = "lightyellow",
  "WUP" = "lightyellow",
  "BUH" = "lightblue1",  
  "KOT" = "lightblue1",  
  "WDG" = "lightblue1",  
  "WED" = "lightblue1" 
)

theme_new <- theme_classic(base_size = 12) +
  theme(axis.line = element_blank(),
        axis.text = element_text(colour = "black"),
        axis.ticks = element_line(linewidth = 0.4, colour = "black"),
        legend.key.size = unit(0.5, "cm"),
        legend.margin = margin(t = 0),
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 9),
        panel.border = element_rect(linewidth = 0.4, colour = "black", fill = NA),
        panel.grid.major.y = element_line(colour = "grey90", linewidth = 0.2),
        plot.margin = margin(2, 2, 2, 2, "pt"),
        plot.title = element_text(size = 10))
theme_set(theme_new)
```

## 0.3. data loading   
 
```{r loading all needed csv files}
### Environmental data ------------

## landscape data from "C:\Users\Almas\Desktop\UNI_LEIPSI\Thesis\Thesis_Rproject\data\landscape_data.csv"
landscape_data <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/corine_data.csv")

## weather data from the Deutscher Wetterdienst (DWD)
dwd_weather <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/dwd_weather_data.csv")

## weather data from the field
field_weather <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/field_weather_data.csv")

## plant data
plants <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/plants3.csv")
relative_flower <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/relative_flower.csv")
top2 <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/top2.csv")

## extrapolated plant data
#inext_plants <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/iNext_AsyEst_plants.csv")

### Traditional methods ------------

## netting data 
netting <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/net_data_long.csv")

## pan trap data for families
pan_family <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/bowltrap_clean.csv")

### Cameras ------------

## flower camera data
flower_camera <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/bioclip_flower_cams.csv")

## platfrom camera data 
platform_camera <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/InsectDetect_platform_cams.csv")
```


## 1. Enivronmental variables

### 1.1. Dwd weather data

```{r dwd weather}
#change dwd_weather date format from 20240724 to 2024-07-24 by adding a "-" after the year and month
dwd_weather <- dwd_weather %>%
  #adding a "-" after the year and month
  mutate(Date = gsub("(\\d{4})(\\d{2})", "\\1-\\2", MESS_DATUM))%>%
  #adding - after the month
  mutate(Date = gsub("(\\d{4}-\\d{2})(\\d{2})", "\\1-\\2", Date))

#select the relevant columns for out analysis: Date, SITE, FM, TMK and rename them properly dm= daily mean
dwd_weather <- dwd_weather %>%
  select("Date"="Date",
         "Site"="SITE",
         "dm_wind_velocity"="FM",
         "dm_temperature"="TMK")
```


We will not keep the weather data written down by hand in the field, as it is not as reliable as the data from the DWD weather station. However, an interesting variable to keep is the start time of walking the transect for the netting method. This could be an important factor in the number of pollinators caught, as some species are more active in the morning or evening.

### 1.2. Field weather data

```{r field weather start time}
#transform field_weather into start_net dataframe
start_net <- field_weather %>%
  select("Date"="date",
         "Site"="SITE",
         "Transect"="transect",
         "Start_time"="start_time")

#transform Start_time into a time format hh:mm
start_net <- start_net %>%
  mutate(Start_time = gsub("\\.", ":", Start_time)) %>%  # Replace '.' with ':'
  mutate(Start_time = sub(":(\\d)$", ":\\10", Start_time)) %>%  # Add trailing 0 for single-digit minutes
  mutate(Start_time = ifelse(grepl("^\\d{1,2}$", Start_time),  # Add ':00' for time without minutes
                             paste0(Start_time, ":00"),
                             Start_time)) %>% 
  mutate(Start_time = paste0(Start_time, ":00")) %>%  # Ensure format is hh:mm:ss
  mutate(Start_time = chron::times(Start_time))  # Convert to time-only format

#rm(field_weather) # field_weather no longer needed
```

### 1.3. Landscape data & combining 

```{r landscape and top2}
Floral_simpson_index <- relative_flower %>%
  select("Site"="Site",
         "Transect"="Transect",
         "Site_type"="Site_type",
         "Floral_simpson_index"="Floral_simpson_index")%>%
  distinct()

envir_data <- start_net %>%
  #join the dwd weather data
  full_join(dwd_weather, by = c("Date" = "Date", "Site"))%>%
  
  #join the landscape data
  full_join(landscape_data, by = c("Site" = "Site"))%>%
  
  #join the top2 data
  full_join(top2, by = c("Site" = "Site", "Transect")) %>%
  
  #remove extra columns
  select( -c("Floral_simpson_index" ,   "Floral_shannon_index"   , "Floral_species_richness", "top2_ratio", "Site_type"))%>%
  #select( -c("top2_ratio", "Floral_shannon_index"   , "Floral_species_richness"))%>%
  
  #add only simpson index from relative_flower 
  full_join(Floral_simpson_index, by= c("Site", "Transect"))%>%
  
  
  #fill in NA with 0 in the Pastinaca.sativa"   "Daucus.carota"   "top2_ratio" columns   
  mutate(across(c("Pastinaca.sativa", "Daucus.carota"), ~replace_na(., 0)))%>%
  
  #change the date to a date format
  mutate(Date = as.Date(Date, format = "%Y-%m-%d"))%>%
  
  #create Days_since_start variable
  mutate(Days_since_start = as.numeric(Date - min(Date)+1))%>%
  
  #rename rows in Site_type column 1-5y to young_restored and Reference to reference
  mutate(Site_type = ifelse(Site_type == "1-5 y", "young_restored", "reference"))
  
```

### 1.4. Correlation matrix of environmental variables

```{r correlation matrix}
#correlation matrix of all the numerical environmental variables
tmp_cor_envir <- envir_data %>%
  select_if(is.numeric) %>%
  na.omit() %>%
  mutate(across(everything(), scale)) # scale the data - Z-score standardization
  
tmp_qq_plots <- list()
# plot Q-Q plots for each variable
for (i in 1:ncol(tmp_cor_envir)) {
  tmp_qq_plots[[i]] <- ggplot(tmp_cor_envir, aes(sample = .data[[colnames(tmp_cor_envir)[i]]])) +
  stat_qq()+
  stat_qq_line()+
  ggtitle(str_wrap(colnames(tmp_cor_envir)[i], width = 20))+
  theme(plot.title = element_text(size = 10))  
}

tmp_qq_plots[[1]]; tmp_qq_plots[[2]]; tmp_qq_plots[[3]]; tmp_qq_plots[[4]]; tmp_qq_plots[[5]]; tmp_qq_plots[[6]]; tmp_qq_plots[[7]]; tmp_qq_plots[[8]]; tmp_qq_plots[[9]];tmp_qq_plots[[10]];tmp_qq_plots[[11]];tmp_qq_plots[[12]]; tmp_qq_plots[[13]]#;tmp_qq_plots[[14]];tmp_qq_plots[[15]];tmp_qq_plots[[16]];tmp_qq_plots[[17]

```

```{r correlation plot}
tmp_env_cor_results <- rcorr(as.matrix(tmp_cor_envir), type = "spearman") 

# extract correlation matrix
tmp_env_cor_matrix <- tmp_env_cor_results$r

# extract the p-values
tmp_env_p_matrix <- tmp_env_cor_results$P

# plot correlation matrix (only insignificant ones hidden)
tmp_corr_num <- corrplot(tmp_env_cor_matrix, 
         type = "upper",
         method = "color",
         diag = F,                         # remove diagonal
         #addCoef.col = "black",           # add coefficient coeffs, not used 
         p.mat = tmp_env_p_matrix,         # add p-values matrix
         sig.level = c(0.001, 0.01, 0.05), # significance thresholds
         tl.col = "black",                 # color of variable labels
         cl.align.text = "l",              # alignment of color legend
         cl.offset = 0.3,                  # offset color legend text to the right
         number.cex = 0.8,                 # size of coefficient text
         tl.cex	= 0.8,                     # size of variable labels
         insig = "label_sig",              # add stars according to significance thresholds
         pch.cex = 0.8)                      # size of stars

# save the plot as a png
dev.copy(png, "C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/figures/correlation_plot_num.png", width = 1600, height = 1600, res = 300)
dev.off()
```

### 1.5. PCA of environmental variables

```{r PCA}
#PCA of the environmental data
tmp_cor_envir_pca <- tmp_cor_envir %>%
  #remove Na values
  na.omit() %>%
  prcomp(, scale = TRUE)

# plot the PCA
(tmp_cor_envir_pca_plot <- fviz_pca_biplot(tmp_cor_envir_pca, 
                                         geom = c("point", "text"), 
                                         col.var = "contrib", # color by contributions to axes
                                         gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), #this gradient indicates the contribution of each variable to the axis
                                         repel = TRUE, # avoid text overlapping
                                         title = "PCA of Environmental Data"))
```

```{r removing temporary envir data}
# remove all dataframes with tmp_ prefix
rm(list = ls(pattern = "^tmp_"))
#rm(top2, landscape_data, dwd_weather, field_weather, start_net)
```


## 2. Traditional methods - PAN TRAPS

### 2.1. Data preparation

```{r}
#the transect values for pan_family are not in the same format as in the envir_data. let's change that
#changing the str to character and then adding a T before the transect number
pan_family <- pan_family %>%
  mutate(Transect = as.character(Transect)) %>%
  mutate(Transect = paste0("T", Transect))

#combine envir_data with pan_family data
pan_family1 <- pan_family %>%
  
  #right date format
  mutate(Date = as.Date(Date, format = "%Y-%m-%d"))%>%
  
  #join the envir_data with pan_family
  left_join(envir_data, by = c("Site", "Transect", "Date", "Site_type"))%>%
  
  #remove extra columns
  select(-Start_time, -Days_since_start)
```

### 2.2. Data exploration

```{r}
# scatterplot the number of taxa caught in the pan traps per transect depending on simpson index
pan_family1 %>%
  #remove 0 count values
  filter(Count > 0) %>%
  ggplot(aes(x = Floral_simpson_index, y = Count)) +
  geom_point(aes(color = Site), alpha = 5) +
  #geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Number of individuals caught in pan traps per transect depending on simpson index",
       x = "Floral simpson index",
       y = "Number of individuals caught") +
  scale_color_manual(values = saturated_pal) +
  theme(legend.position = "left")

#stacked  barplot of the number of individuals caught in the pan traps per transect per site
pan_family1 %>%
  ggplot(aes(x = Site, y = Count, fill = Transect)) +
  geom_bar(stat = "identity") +
  labs(title = "Number of individuals caught in pan traps per transect per site",
       x = "Site",
       y = "Number of individuals caught") +
  #scale_fill_manual(values = saturated_pal) +
  theme(legend.position = "left")

#custom25 <- paletteer_c("grDevices::Hawaii", n = 25) # Extract first 25 colors

custom25 <- c(paletteer_d("khroma::light"),paletteer_d("ggprism::muted_rainbow"),paletteer_d("ggsci::default_flatui"))[1:25]  # Ensure exactly 25 colors


#barplot of the number of each taxon caught in the pan traps per site
pan_family1 %>%
  #group by site and taxa
  group_by(Site, Taxa) %>%
  #sum the count of each taxon
  summarise(Count = sum(Count)) %>%
  ggplot(aes(x = Site, y = Count, fill = Taxa)) +
  geom_bar(stat = "identity", color = "black") +
  labs(title = "Count of each taxon caught in pan traps per site",
       x = "Site",
       y = "Number of individuals caught") +
  #viridis  color palette for the taxa 
  #scale_fill_viridis_d(option = "rocket") +
  scale_fill_manual(values = custom25) +  # Apply manually
  theme(legend.position = "left")


#plot of count vs floral simpson index
pan_family1 %>%
  #remove 0 count values
  #filter(Count > 0) %>%
  ggplot(aes(x = Floral_simpson_index, y = Count)) +
  geom_point(aes(color = Site), alpha = 5) +
  #geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Count vs Floral Simpson Index",
       x = "Floral Simpson Index",
       y = "Count") +
  scale_color_manual(values = saturated_pal) +
  theme(legend.position = "bottom")
```

### 2.3. Pan traps vs InsectDetect


```{r insectdetect more than 0.5}
#barplot of the number of each taxon caught with the platform camera per site
platform_camera %>%
  #filter out top1 that start with none_ as they are not real taxa
  filter(!grepl("none_", top1)) %>%
  #remove top1_prob_weighted that are below 0.5
  #filter(top1_prob_weighted > 0.5) %>%
  #group by site and taxa
  group_by(location, top1) %>%
  #count the number of each top1 caught
  summarise(Count = n()) %>%
  ggplot(aes(x = location, y = Count, fill = top1)) +
  geom_bar(stat = "identity", color = "black") +
  labs(title = "Count of each taxon caught in pan traps per site",
       x = "Site",
       y = "Number of individuals caught") +
  #viridis  color palette for the taxa 
  #scale_fill_viridis_d(option = "rocket") +
  scale_fill_manual(values = custom25) +  # Apply manually
  theme(legend.position = "left")
```

```{r combining pan traps and insectdetect}
# unify the taxa names in both datasets
tmp_pan_family <- pan_family%>%
 # adapt taxa categories to the ones used in platform data (less precise)
  mutate(Category = case_when(
    Taxa %in% c("cantharidae", "carabidae", "curculionidae", "elateridae",
                "mordellidae", "staphylinidae") ~ "beetle",
    Taxa %in% c("coccinellidae") ~ "beetle_cocci",
    Taxa %in% c("hemiptera") ~ "bug",
    Taxa %in% c("diptera","calliphoridae","cecidomyiidae","tachinidae","calliphoridae",
                "sepsidae","ephydridae","muscidae","asilidae","stratiomyidae", "polleniidae","acalyptrate" ) ~ "fly",
    Taxa %in% c("dasypoda","apidae","colletidae") ~ "bee_apis",
    Taxa %in% c("bombus") ~ "bee_bombus",
    Taxa %in% c("sarcophagidae") ~ "fly_sarco",
    Taxa %in% c("symphyta","apocrita","proctotrupidae","tenthredinidae") ~ "wasp",
    Taxa %in% c("empididae") ~ "fly_empi",
    TRUE ~ Taxa
    ))%>%
    #remove all rows that have a 0 "count" value
  filter(Count != 0) %>%
  
  #select only the relevant columns for the comparison
  select(Site, Transect, Site_type, Category, Count)

#select only the relevant columns fo platform_camera for the comparison
tmp_platform_camera <- platform_camera %>%
  
  mutate(transect = as.character(transect)) %>%
  mutate(transect = paste0("T", transect))%>%
  
  #filter out top1 that start with none_ as they are not real taxa
  filter(!grepl("none_", top1)) %>%
  
  #remove top1_prob_weighted that are below 0.5
  filter(top1_prob_weighted > 0.85) %>%
  
  #group by site and taxa
  group_by(location,transect, top1) %>%
  
  #count the number of each top1 caught
  summarise(Count = n()) %>%
  ungroup() %>%
  
  #add empty Site_Type column
  mutate(Site_type = NA)%>%
  
  #remove columns that not needed for comparison with pan_family, rename top1 to Category
  select(Site=location, Site_type,Transect=transect, Category = top1, Count)


#add method column to both pan_family and platform_camera
tmp_pan_family$Method <- "bowl_trap"
tmp_platform_camera$Method <- "platform_camera"

#combine the two datasets
tmp_combined <- rbind(tmp_pan_family, tmp_platform_camera)%>%
  #adapt empty Site_type following the Site column
  mutate(Site_type = ifelse(Site %in% c("DES", "HLI", "JEP", "STP", "WUP"), "reference", "young_restored"))

tmp_combined %>%
  ggplot(aes(x = Site, y = Count, fill = Category)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~Method, ncol=1) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Comparison of the two sampling methods",
       x = "Site",
       y = "Count")+
    scale_fill_manual(values = custom25)
  # Add confidence threshold annotation
  #annotate("text", x = Inf, y = Inf, label = paste("Confidence threshold:", 0.85), hjust = 1.1, vjust = 1.1, size = 3)

sum(tmp_combined$Count[tmp_combined$Method == "bowl_trap"])
sum(tmp_combined$Count[tmp_combined$Method == "platform_camera"])
```

```{r interactive threshold adjustment}
library(shiny)
library(ggplot2)
library(dplyr)

# Define UI
ui <- fluidPage(
  titlePanel("Interactive Threshold Adjustment"),
  sidebarLayout(
    sidebarPanel(
      sliderInput("threshold", "Select top1_prob_weighted threshold:", 
                  min = 0.4, max = 1.0, value = 0.85, step = 0.01)
    ),
    mainPanel(
      plotOutput("barPlot"),
      verbatimTextOutput("counts")
    )
  )
)

# Define server logic
server <- function(input, output) {
  
  # Reactive dataset based on threshold
  filtered_data <- reactive({
    tmp_platform_camera <- platform_camera %>%
      mutate(transect = as.character(transect)) %>%
      mutate(transect = paste0("T", transect)) %>%
      filter(!grepl("none_", top1)) %>%
      filter(top1_prob_weighted > input$threshold) %>%
      group_by(location, transect, top1) %>%
      summarise(Count = n(), .groups = "drop") %>%
      mutate(Site_type = NA) %>%
      select(Site = location, Site_type, Transect = transect, Category = top1, Count)
    
    tmp_pan_family$Method <- "bowl_trap"
    tmp_platform_camera$Method <- "platform_camera"
    
    tmp_combined <- rbind(tmp_pan_family, tmp_platform_camera) %>%
      mutate(Site_type = ifelse(Site %in% c("DES", "HLI", "JEP", "STP", "WUP"), 
                                "reference", "young_restored"))
    
    return(tmp_combined)
  })
  
  # Render plot
  output$barPlot <- renderPlot({
    ggplot(filtered_data(), aes(x = Site, y = Count, fill = Category)) +
      geom_bar(stat = "identity", position = "stack") +
      facet_wrap(~Method) +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
      labs(title = "Comparison of the two sampling methods",
           x = "Site",
           y = "Count") +
      scale_fill_manual(values = custom25)
  })
  
  # Show sum of counts for each method
  output$counts <- renderText({
    data <- filtered_data()
    bowl_count <- sum(data$Count[data$Method == "bowl_trap"], na.rm = TRUE)
    platform_count <- sum(data$Count[data$Method == "platform_camera"], na.rm = TRUE)
    paste("Total Count (Bowl Trap):", bowl_count, "\nTotal Count (Platform Camera):", platform_count)
  })
}

# Run the application 
shinyApp(ui = ui, server = server)
```

```{r}
#remove all dataframes with tmp_ prefix
rm(list = ls(pattern = "^tmp_"))
```

## 3. Automated methods - PLATFORM CAMERAS

### 3.1. Data preparation

```{r}

```


## 4. Automated methods - FLOWER CAMERAS

### 4.1. Data preparation

```{r structure}
#change format of "time" column from hh-mm-ss to hh:mm:ss
flower_camera <- flower_camera %>%
  mutate(time = gsub("\\-", ":", time)) %>%  # Replace '-' with ':'
  mutate(time = chron::times(time))%>%  # Convert to time-only format
  #change format of "date" 
  mutate(date = as.Date(date, format = "%Y-%m-%d"))

str(flower_camera)
```


```{r all data from flower cameras}
custom193 <- paletteer_c("ggthemes::Sunset-Sunrise Diverging", n = 193)

# Replace "other_families" with gray
custom193_named <- setNames(custom193, sort(unique(flower_camera$Classification_Category)))
custom193_named["other_families"] <- "gray50"  # Adjust shade if needed

#plot of the number of each taxon caught in the flower cameras per site
flower_camera %>%
  #summarise per site and count the number of each taxon caught
  group_by(site, Classification_Category) %>%
  summarise(Count = n(), .groups = "drop") %>%
  
  ggplot(aes(x = site, y = Count, fill = Classification_Category)) +
  geom_bar(stat = "identity") +
  labs(title = "Count of each taxon caught with flower cameras per site",
       x = "Site",
       y = "Number of individuals caught") +
  theme(legend.position = "none") +
  scale_fill_manual(values = custom193_named)   # Apply manually
```
```{r threshold adjustment plotting}
#remove rows with Classification_Category "other_families"
flower_camera <- flower_camera %>%
 #filter out the rows where Classification_Category is "other_families"
  filter(Classification_Category != "other_families")
  
  
## Define THRESHOLD ----
TH <- 0.8

#histogram of the Family_Confidence
flower_camera %>%
  ggplot(aes(x = Family_Confidence)) +
  geom_histogram(binwidth = 0.05, fill = "lightblue", color = "black") +
  labs(title = "Histogram of Family Confidence",
       x = "Family Confidence",
       y = "Count")+
  #add a vertical line at the threshold
  geom_vline(xintercept = TH, color = "red", linetype = "dashed")+  
  # Add confidence threshold annotation
  annotate("text", x = Inf, y = Inf, label = paste("Confidence threshold:", TH), 
           hjust = 1.1, vjust = 1.1, size = 3, color = "red")

#new dataframe above TH
flower_camera_light <- flower_camera %>%
  #remove path column
  select(-Image_Path) %>%
  #filter out the rows where Family_Confidence is below the threshold
  filter(Family_Confidence > TH) %>% 
  #fill Site_type column with reference or young_restored
  mutate(Site_type = ifelse(site %in% c("DES", "HLI", "JEP", "STP", "WUP"), "reference", "young_restored"))
  
#calculate the proportion of rows removed
diff <- nrow(flower_camera) - nrow(flower_camera_light)
prop <- diff / nrow(flower_camera) 

#print 
print(paste("By removing rows with a confidence score below the threshold", TH, ", we remove", round(prop,2), "of the data."))
#remove 
rm(diff, prop)

#plot of the number of each taxon caught in the flower cameras per site
flower_camera_light %>%
  #summarise per site and count the number of each taxon caught
  group_by(site, Classification_Category) %>%
  summarise(Count = n(), .groups = "drop") %>%
  
  ggplot(aes(x = site, y = Count, fill = Classification_Category)) +
  geom_bar(stat = "identity") +
  labs(title = "Count of each taxon caught in flower cameras per site",
       x = "Site",
       y = "Number of individuals caught") +
  theme(legend.position = "none") +
  scale_fill_manual(values = custom193_named)  +  
  # Add confidence threshold annotation
  annotate("text", x = Inf, y = Inf, label = paste("Confidence threshold:", TH), 
           hjust = 1.1, vjust = 1.1, size = 3)

#plot of the number of each taxon caught in per flower species 
flower_camera_light %>%
  #summarise per site and count the number of each taxon caught
  group_by(site, Classification_Category, flower_sp) %>%
  summarise(Count = n(), .groups = "drop") %>%
  
  ggplot(aes(x = flower_sp, y = Count, fill = Classification_Category)) +
  geom_bar(stat = "identity") +
  labs(title = "Count of each taxon caught in flower cameras per flower species",
       x = "Flower Species",
       y = "Number of individuals caught") +
  theme(legend.position = "none") +
  #slant the x-axis labels
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = custom193_named) +  
  # Add confidence threshold annotation
  annotate("text", x = Inf, y = Inf, label = paste("Confidence threshold:", TH), 
           hjust = 1.1, vjust = 1.1, size = 3)
```

### 4.2. Data exploration - Individuals vs time

```{r individuals vs time}
#plot of the number of individuals caught in the flower cameras over time
# Convert time to POSIXct by combining with the date
binned_data <- flower_camera_light %>%
  mutate(
    datetime = as.POSIXct(paste(date, time), format = "%Y-%m-%d %H:%M:%S"),  # Ensure proper datetime format
    time_bin = floor_date(datetime, "10 minutes"))%>%  # Bin into 5-minute chunks
  #remove date from the time_bin column
  mutate(time_bin = format(time_bin, "%H:%M:%S"))

# Summarize count of individuals per family per time bin
binned_data <- binned_data %>%
  group_by(date,site,time_bin, Family) %>%
  summarise(Count = n(), .groups = "drop")%>%
  #change time_bin to a character
  mutate(time_bin = as.character(time_bin))

# Plot the data
ggplot(binned_data, aes(x = time_bin, y = Count, color = Family)) +
  geom_point() +
  labs(
    title = "Number of Individuals Per Family Over Time (10-min Bins)",
    x = "Time (10-minute bins)",
    y = "Count of Individuals"
  ) +
  facet_wrap(~site) +
  theme_minimal() +
  theme(legend.position = "none")+
  # format x-axis to show labels every hour
  scale_x_discrete(
      breaks = binned_data$time_bin[grepl("00:00$|30:00$", binned_data$time_bin)],
      labels = gsub(":00$", "", binned_data$time_bin[grepl("00:00$|30:00$", binned_data$time_bin)]))+
  #slant the x-axis labels
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_color_manual(values = custom193_named)   # Apply manually

rm(binned_data)
```



### 4.3. Data exploration - Daucus carota

Here, we'll focus on the Daucus carota species, as it is a common plant species in the study area and is known to attract a variety of pollinators. 

Since the cameras didn't have an ID tracking system, we'll have a look at taxonomic richness and relative abundance of pollinators attracted to Daucus carota.

```{r daucus carota both methods}
daucus_cam <- flower_camera_light %>%
  #filter out the rows where the flower species is Daucus.carota
  filter(flower_sp == "Daucus carota") %>%
  group_by(site) %>%
  summarise(unique_families = unique(Classification_Category),
            .groups = "drop")%>%
  #add Count column filled with 1 
  mutate(Count = 1)

#same thing with netting
daucus_net <- netting %>%
  #filter out the rows where the flower species is Daucus.carota
  filter(plant_species == "Daucus carota") %>%
  group_by(site) %>%
  summarise(unique_families = unique(family),
            .groups = "drop")%>%
  #add Count column filled with 1 
  mutate(Count = 1)

# Combine both datasets, adding a column to differentiate methods
daucus <- bind_rows(
  daucus_cam %>% mutate(method = "Camera"),
  daucus_net %>% mutate(method = "Net")
)

#combining all the unique families caught on Daucus with nets and cameras
fams <- sort(unique(daucus$unique_families));length(fams) # Get unique families sorted alphabetically
customfam <- paletteer_c("pals::kovesi.rainbow_bgyrm_35_85_c69", n = length(fams))
customfam <- setNames(customfam, fams)

# Create a single ggplot with faceting
final_plot1 <- ggplot(daucus, aes(x = site, y = Count, fill = unique_families)) +
  geom_bar(stat = "identity") +
  facet_wrap(~method, ncol = 1) +  # Separate plots
  labs(title = "Pollinator Family richness caught on Daucus carota",
       x = "Site",
       y = "Number of unique families caught") +
  theme(legend.position = "right") +  # Shared legend at bottom
  scale_fill_manual(values = customfam)  # Consistent colors

# Create a single ggplot with faceting
final_plot2 <- ggplot(daucus, aes(x = method, y = Count, fill = unique_families)) +
  geom_bar(stat = "identity") +
  labs(title = "Pollinator Family richness caught on Daucus carota",
       x = "Site",
       y = "Number of unique families caught") +
  theme(legend.position = "right") +  # Shared legend at bottom
  scale_fill_manual(values = customfam)  # Consistent colors

# Print the final plot
print(final_plot1); print(final_plot2)
```

```{r}
rm(daucus_cam, daucus_net, fams, customfam, final_plot1, final_plot2)
```

