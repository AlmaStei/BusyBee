---
title: "Overall_analysis_GLMM"
author: "Alma Steireif"
date: "`r Sys.Date()`"
output: 
  html_document:
      toc: TRUE
---

## 0.0. Description



## Hypotheses

*Q1: Do reference and restored sites exhibit differences in pollinator biodiversity?*

  **H0:**
  • no significant difference between reference and restored sites in pollinator biodiversity
  → pollinators are highly mobile and can easily colonize restored habitats, thereby achieving similar biodiversity and composition to reference sites.
  
  **H1:**
  • pollinator diversity is higher in reference sites compared to young restored sites
  → habitat complexity, trophic levels, vegetation structure, and resource availability, all take time to develop in restored sites


*Q2: Do traditional and automated methods yield different compositions of pollinators?*

  **H0:**
  • no significant differences in pollinator composition detected by traditional and automated methods
  → because all methods aim to capture a representative sample of the pollinator community.
  
  **H1:**
  • Traditional and automated methods yield different compositions of pollinators
  → due to inherent biases in sampling efficiency, taxonomy resolution, and target taxa, leading to discrepancies in the detection of certain pollinators.
  
*Q3: Can automated methods effectively detect biodiversity changes between reference and restored sites?*

  **H0:**
  • Automated methods do not effectively detect biodiversity changes between reference and restored sites
  → due to limitations in capturing the full spectrum of pollinator abundance and species richness, as well as potential challenges in achieving high taxonomic resolution.
  
  **H1:**
  • Automated methods can effectively detect biodiversity differences between reference and restored sites
  → machine learning algorithms can offer improved sensitivity and accuracy in detecting shifts in pollinator communities over time.

## 0. Setup    

### libraries    

```{r setup, include=FALSE}

library(vegan)  # For diversity indices
library(paletteer)  # For color palettes
library(RColorBrewer)  # For color palettes

library(reshape2)
library(patchwork) #for wrapping plots
library(chron)  # for time data
library(lubridate)  # for date data

library(Hmisc)  # correlation matrix
library(corrplot)  # plotting
library(factoextra) #install library for fviz_pca

library(easystats)#library(parameters) #library(performance)
library(lme4)
library(ggeffects)
library(arm) #for residual plots of binomial models
library(DHARMa) #for residual plots
#library(datawizard) #chek documentation
library(pscl) #for zero inflation test
#library(mgcv) #tweedie models

library(tidyverse) 
```

### aesthetics

```{r custom colors}
#define custom colors for plotting
saturated_pal <- c(
  #reference sites
  "DES" = "#7F3B19FF",  
  "HLI" = "#FDB863FF",  
  "JEP" = "#E08214FF",  
  "STP" = "#B35806FF",
  "WUP" = "#FEE0B6FF",
  # restored sites
  "BUH" = "#93C6E1FF",  
  "KOT" = "#5F93ACFF",  
  "WDG" = "#2E627AFF",  
  "WED" = "#00344AFF"  
)

# bicolor palette
bicolor_pal <- c(
  "DES" = "darkorange",  
  "HLI" = "darkorange",  
  "JEP" = "darkorange",  
  "STP" = "darkorange",
  "WUP" = "darkorange",
  "BUH" = "steelblue",  
  "KOT" = "steelblue",  
  "WDG" = "steelblue",  
  "WED" = "steelblue" 
)

bicolor_bg <- c(
  "DES" = "lightyellow",  
  "HLI" = "lightyellow",  
  "JEP" = "lightyellow",  
  "STP" = "lightyellow",
  "WUP" = "lightyellow",
  "BUH" = "lightblue1",  
  "KOT" = "lightblue1",  
  "WDG" = "lightblue1",  
  "WED" = "lightblue1" 
)

theme_new <- theme_classic(base_size = 12) +
  theme(axis.line = element_blank(),
        axis.text = element_text(colour = "black"),
        axis.ticks = element_line(linewidth = 0.4, colour = "black"),
        legend.key.size = unit(0.5, "cm"),
        legend.margin = margin(t = 0),
        legend.text = element_text(size = 8),
        legend.title = element_text(size = 9),
        panel.border = element_rect(linewidth = 0.4, colour = "black", fill = NA),
        panel.grid.major.y = element_line(colour = "grey90", linewidth = 0.2),
        plot.margin = margin(2, 2, 2, 2, "pt"),
        plot.title = element_text(size = 10))
theme_set(theme_new)
```

## 0.3. data loading   
 
```{r loading all needed csv files}
### Environmental data ------------

## landscape data from "C:\Users\Almas\Desktop\UNI_LEIPSI\Thesis\Thesis_Rproject\data\landscape_data.csv"
landscape_data <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/corine_data.csv")

## weather data from the Deutscher Wetterdienst (DWD)
dwd_weather <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/dwd_weather_data.csv")

## weather data from the field
field_weather <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/field_weather_data.csv")

## plant data
plants <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/plants3.csv")
relative_flower <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/relative_flower.csv")
top2 <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/top2.csv")

## extrapolated plant data
#inext_plants <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/iNext_AsyEst_plants.csv")

### Traditional methods ------------

## netting data 
netting <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/net_data_long.csv")

## pan trap data for families
pan_family <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/bowltrap_clean.csv")

### Cameras ------------

## flower camera data
flower_camera <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/bioclip_flower_cams.csv")

## platfrom camera data 
platform_camera <- read.csv("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/InsectDetect_platform_cams.csv")
```


## 1. Enivronmental variables

### 1.1. Dwd weather data

```{r dwd weather}
#change dwd_weather date format from 20240724 to 2024-07-24 by adding a "-" after the year and month
dwd_weather <- dwd_weather %>%
  #adding a "-" after the year and month
  mutate(Date = gsub("(\\d{4})(\\d{2})", "\\1-\\2", MESS_DATUM))%>%
  #adding - after the month
  mutate(Date = gsub("(\\d{4}-\\d{2})(\\d{2})", "\\1-\\2", Date))

#select the relevant columns for out analysis: Date, SITE, FM, TMK and rename them properly dm= daily mean
dwd_weather <- dwd_weather %>%
  dplyr::select("Date"="Date",
         "Site"="SITE",
         "dm_wind_velocity"="FM",
         "dm_temperature"="TMK")
```


We will not keep the weather data written down by hand in the field, as it is not as reliable as the data from the DWD weather station. However, an interesting variable to keep is the start time of walking the transect for the netting method. This could be an important factor in the number of pollinators caught, as some species are more active in the morning or evening.

### 1.2. Field weather data - Start time of netting

```{r field weather start time}
#transform field_weather into start_net dataframe
start_net <- field_weather %>%
  dplyr::select(
         "Date"="date",
         "Site"="SITE",
         "Transect"="transect",
         "Start_time"="start_time")

start_net <- start_net %>%
  mutate(
    Start_time = gsub("\\.", ":", Start_time),  # Replace "." with ":"
    Start_time = ifelse(Start_time == "9:25", "09:25", Start_time),  # Fix specific case
    Start_time = ifelse(nchar(Start_time) == 4, paste0(Start_time, "0"), Start_time),  # Ensure "14:0" -> "14:00"
    Start_time = ifelse(nchar(Start_time) == 2, paste0(Start_time, ":00"), Start_time),  # Ensure "14" -> "14:00"
    Hour = as.integer(substr(Start_time, 1, 2)),  # Extract hour
    Minute = as.integer(substr(Start_time, 4, 5)),  # Extract minutes
    Time_Bin = ifelse(Minute < 30, sprintf("%02d:00", Hour), sprintf("%02d:30", Hour)) , # Ensure proper format
    Time_category = ifelse(Minute < 30, Hour, Hour + 0.5),  # Convert 11:30 to 11.5
    #change Time_category to integers from 9.0 -> 1, 9.5 -> 2, 10.0 -> 3, 10.5 -> 4 etc
    Time_category = case_when(
      Time_category == 9.0 ~ 1,
      Time_category == 9.5 ~ 2,
      Time_category == 10.0 ~ 3,
      Time_category == 10.5 ~ 4,
      Time_category == 11.0 ~ 5,
      Time_category == 11.5 ~ 6,
      Time_category == 12.0 ~ 7,
      Time_category == 12.5 ~ 8,
      Time_category == 13.0 ~ 9,
      Time_category == 13.5 ~ 10,
      Time_category == 14.0 ~ 11,
      Time_category == 14.5 ~ 12,
      Time_category == 15.0 ~ 13,
      Time_category == 15.5 ~ 14,
      Time_category == 16.0 ~ 15,
      Time_category == 16.5 ~ 16,
      Time_category == 17.0 ~ 17,
      TRUE ~ NA_real_  )) %>% # Handle any other cases  
  dplyr::select(-Hour, -Minute)# Remove temporary columns

     

#barplot start time per site, colored by transect
start_net %>%
    ggplot(aes(x = Site, y = Time_Bin, fill = Transect)) +
  geom_bar(stat = "identity", position= "dodge") +
  labs(title = "Start time of netting per site",
       x = "Site",
       y = "Start time") +
  theme(legend.position = "left")+
  #viridis
  scale_fill_viridis_d() 

write.csv(start_net, "C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/start_net.csv", row.names = FALSE)

```

### 1.3. Landscape data & combining 

```{r landscape and top2}
Floral_simpson_index <- relative_flower %>%
  dplyr::select("Site"="Site",
         "Transect"="Transect",
         "Site_type"="Site_type",
         "Floral_simpson_index"="Floral_simpson_index")%>%
  distinct()

envir_data <- start_net %>%
  #select the relevant columns
  dplyr::select(-c("Start_time", "Time_Bin"))%>%
  
  #join the dwd weather data
  full_join(dwd_weather, by = c("Date" = "Date", "Site"))%>%
  
  #join the landscape data
  full_join(landscape_data, by = c("Site" = "Site"))%>%
  
  #join the top2 data
  full_join(top2, by = c("Site" = "Site", "Transect")) %>%
  
  #remove extra columns
  dplyr::select(-c( "Site_type"))%>%
  #dplyr::select( -c("top2_ratio", "Site_type"))%>%
  #dplyr::select( -c("top2_ratio", "Floral_shannon_index"   , "Floral_species_richness"))%>%
  
  #add only simpson index from relative_flower 
  full_join(Floral_simpson_index, by= c("Site", "Transect"))%>%
  
  
  #fill in NA with 0 in the Pastinaca.sativa"   "Daucus.carota"   "top2_ratio" columns   
  mutate(across(c("Pastinaca.sativa", "Daucus.carota"), ~replace_na(., 0)))%>%
  mutate(across(c("top2_ratio"), ~replace_na(., 0)))%>%

  
  #change the date to a date format
  mutate(Date = as.Date(Date, format = "%Y-%m-%d"))%>%
  
  #create Days_since_start variable
  mutate(Days_since_start = as.numeric(Date - min(Date)+1))%>%
  
  #rename rows in Site_type column 1-5y to young_restored and Reference to reference
  mutate(Site_type = ifelse(Site_type == "1-5 y", "young_restored", "reference"))

```

### 1.4. Correlation matrix of environmental variables

```{r correlation matrix}
#correlation matrix of all the numerical environmental variables
tmp_cor_envir <- envir_data %>%
  select_if(is.numeric) %>%
  na.omit() %>%
  mutate(across(everything(), scale)) # scale the data - Z-score standardization
  
tmp_qq_plots <- list()
# plot Q-Q plots for each variable
for (i in 1:ncol(tmp_cor_envir)) {
  tmp_qq_plots[[i]] <- ggplot(tmp_cor_envir, aes(sample = .data[[colnames(tmp_cor_envir)[i]]])) +
  stat_qq()+
  stat_qq_line()+
  ggtitle(str_wrap(colnames(tmp_cor_envir)[i], width = 20))+
  theme(plot.title = element_text(size = 10))  
}

tmp_qq_plots[[1]]; tmp_qq_plots[[2]]; tmp_qq_plots[[3]]; tmp_qq_plots[[4]]; tmp_qq_plots[[5]]; tmp_qq_plots[[6]]; tmp_qq_plots[[7]]; tmp_qq_plots[[8]]; tmp_qq_plots[[9]];tmp_qq_plots[[10]];tmp_qq_plots[[11]];tmp_qq_plots[[12]]; tmp_qq_plots[[13]]
#;tmp_qq_plots[[14]];tmp_qq_plots[[15]];tmp_qq_plots[[16]];tmp_qq_plots[[17]

```

```{r correlation plot}
tmp_env_cor_results <- rcorr(as.matrix(tmp_cor_envir), type = "spearman") 

# extract correlation matrix
tmp_env_cor_matrix <- tmp_env_cor_results$r

# extract the p-values
tmp_env_p_matrix <- tmp_env_cor_results$P

# plot correlation matrix (only insignificant ones hidden)
tmp_corr_num <- corrplot::corrplot(tmp_env_cor_matrix, 
         type = "upper",
         method = "color",
         diag = F,                         # remove diagonal
         #addCoef.col = "black",           # add coefficient coeffs, not used 
         p.mat = tmp_env_p_matrix,         # add p-values matrix
         sig.level = c(0.001, 0.01, 0.05), # significance thresholds
         tl.col = "black",                 # color of variable labels
         cl.align.text = "l",              # alignment of color legend
         cl.offset = 0.3,                  # offset color legend text to the right
         number.cex = 0.8,                 # size of coefficient text
         tl.cex	= 0.8,                     # size of variable labels
         insig = "label_sig",              # add stars according to significance thresholds
         pch.cex = 0.8)                      # size of stars

# save the plot as a png
dev.copy(png, "C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/figures/correlation_plot_num.png", width = 1600, height = 1600, res = 300)
dev.off()
```

### 1.5. PCA of environmental variables

```{r PCA}
#PCA of the environmental data
tmp_cor_envir_pca <- tmp_cor_envir %>%
  #remove Na values
  na.omit() %>%
  prcomp(, scale = TRUE)

# plot the PCA
(tmp_cor_envir_pca_plot <- fviz_pca_biplot(tmp_cor_envir_pca, 
                                         geom = c("point", "text"), 
                                         col.var = "contrib", # color by contributions to axes
                                         gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"), #this gradient indicates the contribution of each variable to the axis
                                         repel = TRUE, # avoid text overlapping
                                         title = "PCA of Environmental Data"))
```

```{r removing temporary envir data}
# remove all dataframes with tmp_ prefix
rm(list = ls(pattern = "^tmp_"))
#rm(top2, landscape_data, dwd_weather, field_weather, start_net)
```

## 2. Traditional methods - NETTING

### 2.1. Data preparation




## 3. Traditional methods - PAN TRAPS

### 3.1. Data preparation

```{r}
#the transect values for pan_family are not in the same format as in the envir_data. let's change that
#changing the str to character and then adding a T before the transect number
pan_family <- pan_family %>%
  mutate(Transect = as.character(Transect)) %>%
  mutate(Transect = paste0("T", Transect))

#combine envir_data with pan_family data
pan_family1 <- pan_family %>%
  
  #right date format
  mutate(Date = as.Date(Date, format = "%Y-%m-%d"))%>%
  
  #join the envir_data with pan_family
  left_join(envir_data, by = c("Site", "Transect", "Date", "Site_type"))%>%
  
  #remove extra columns
  dplyr::select(-Time_category, -Days_since_start)
```

### 3.2. Data exploration

```{r}
# scatterplot the number of taxa caught in the pan traps per transect depending on simpson index
pan_family1 %>%
  #remove 0 count values
  filter(Count > 0) %>%
  ggplot(aes(x = Floral_simpson_index, y = Count)) +
  geom_point(aes(color = Site), alpha = 5) +
  #geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Number of individuals caught in pan traps per transect depending on simpson index",
       x = "Floral simpson index",
       y = "Number of individuals caught") +
  scale_color_manual(values = saturated_pal) +
  theme(legend.position = "left")

#stacked  barplot of the number of individuals caught in the pan traps per transect per site
pan_family1 %>%
  ggplot(aes(x = Site, y = Count, fill = Transect)) +
  geom_bar(stat = "identity") +
  labs(title = "Number of individuals caught in pan traps per transect per site",
       x = "Site",
       y = "Number of individuals caught") +
  #scale_fill_manual(values = saturated_pal) +
  theme(legend.position = "left")

#custom25 <- paletteer_c("grDevices::Hawaii", n = 25) # Extract first 25 colors

custom25 <- c(paletteer_d("khroma::light"),paletteer_d("ggprism::muted_rainbow"),paletteer_d("ggsci::default_flatui"))[1:25]  # Ensure exactly 25 colors


#barplot of the number of each taxon caught in the pan traps per site
pan_family1 %>%
  #group by site and taxa
  group_by(Site, Taxa) %>%
  #sum the count of each taxon
  summarise(Count = sum(Count)) %>%
  ggplot(aes(x = Site, y = Count, fill = Taxa)) +
  geom_bar(stat = "identity", color = "black") +
  labs(title = "Count of each taxon caught in pan traps per site",
       x = "Site",
       y = "Number of individuals caught") +
  #viridis  color palette for the taxa 
  #scale_fill_viridis_d(option = "rocket") +
  scale_fill_manual(values = custom25) +  # Apply manually
  theme(legend.position = "left")


#plot of count vs floral simpson index
pan_family1 %>%
  #remove 0 count values
  #filter(Count > 0) %>%
  ggplot(aes(x = Floral_simpson_index, y = Count)) +
  geom_point(aes(color = Site), alpha = 5) +
  #geom_smooth(method = "lm", se = FALSE) +
  labs(title = "Count vs Floral Simpson Index",
       x = "Floral Simpson Index",
       y = "Count") +
  scale_color_manual(values = saturated_pal) +
  theme(legend.position = "bottom")
```

### 3.3. Pan traps vs InsectDetect


```{r insectdetect more than 0.5}
#barplot of the number of each taxon caught with the platform camera per site
platform_camera %>%
  #filter out top1 that start with none_ as they are not real taxa
  filter(!grepl("none_", top1)) %>%
  #remove top1_prob_weighted that are below 0.5
  #filter(top1_prob_weighted > 0.5) %>%
  #group by site and taxa
  group_by(location, top1) %>%
  #count the number of each top1 caught
  summarise(Count = n()) %>%
  ggplot(aes(x = location, y = Count, fill = top1)) +
  geom_bar(stat = "identity", color = "black") +
  labs(title = "Count of each taxon caught on platforms per site",
       x = "Site",
       y = "Number of individuals caught") +
  #viridis  color palette for the taxa 
  #scale_fill_viridis_d(option = "rocket") +
  scale_fill_manual(values = custom25) +  # Apply manually
  theme(legend.position = "left")
```

```{r combining pan traps and insectdetect}
# unify the taxa names in both datasets
tmp_pan_family <- pan_family%>%
 # adapt taxa categories to the ones used in platform data (less precise)
  mutate(Category = case_when(
    Taxa %in% c("cantharidae", "carabidae", "curculionidae", "elateridae",
                "mordellidae", "staphylinidae") ~ "beetle",
    Taxa %in% c("coccinellidae") ~ "beetle_cocci",
    Taxa %in% c("hemiptera") ~ "bug",
    Taxa %in% c("diptera","calliphoridae","cecidomyiidae","tachinidae","calliphoridae",
                "sepsidae","ephydridae","muscidae","asilidae","stratiomyidae", "polleniidae","acalyptrate" ) ~ "fly",
    Taxa %in% c("dasypoda","apidae","colletidae") ~ "bee_apis",
    Taxa %in% c("bombus") ~ "bee_bombus",
    Taxa %in% c("sarcophagidae") ~ "fly_sarco",
    Taxa %in% c("symphyta","apocrita","proctotrupidae","tenthredinidae") ~ "wasp",
    Taxa %in% c("empididae") ~ "fly_empi",
    TRUE ~ Taxa
    ))%>%
    #remove all rows that have a 0 "count" value
  filter(Count != 0) %>%
  
  #select only the relevant columns for the comparison
  dplyr::select(Site, Transect, Site_type, Category, Count)

#select only the relevant columns fo platform_camera for the comparison
tmp_platform_camera <- platform_camera %>%
  
  mutate(transect = as.character(transect)) %>%
  mutate(transect = paste0("T", transect))%>%
  
  #filter out top1 that start with none_ as they are not real taxa
  filter(!grepl("none_", top1)) %>%
  
  #remove top1_prob_weighted that are below 0.5
  filter(top1_prob_weighted > 0.85) %>%
  
  #group by site and taxa
  group_by(location,transect, top1) %>%
  
  #count the number of each top1 caught
  summarise(Count = n()) %>%
  ungroup() %>%
  
  #add empty Site_Type column
  mutate(Site_type = NA)%>%
  
  #remove columns that not needed for comparison with pan_family, rename top1 to Category
  dplyr::select(Site=location, Site_type,Transect=transect, Category = top1, Count)


#add method column to both pan_family and platform_camera
tmp_pan_family$Method <- "bowl_trap"
tmp_platform_camera$Method <- "platform_camera"

#combine the two datasets
tmp_combined <- rbind(tmp_pan_family, tmp_platform_camera)%>%
  #adapt empty Site_type following the Site column
  mutate(Site_type = ifelse(Site %in% c("DES", "HLI", "JEP", "STP", "WUP"), "reference", "young_restored"))

tmp_combined %>%
  ggplot(aes(x = Site, y = Count, fill = Category)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~Method, ncol=1) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Comparison of the two sampling methods",
       x = "Site",
       y = "Count")+
    scale_fill_manual(values = custom25)
  # Add confidence threshold annotation
  #annotate("text", x = Inf, y = Inf, label = paste("Confidence threshold:", 0.85), hjust = 1.1, vjust = 1.1, size = 3)

sum(tmp_combined$Count[tmp_combined$Method == "bowl_trap"])
sum(tmp_combined$Count[tmp_combined$Method == "platform_camera"])
```

```{r interactive threshold adjustment}
library(shiny)
library(ggplot2)
library(dplyr)

# Define UI
ui <- fluidPage(
  titlePanel("Interactive Threshold Adjustment"),
  sidebarLayout(
    sidebarPanel(
      sliderInput("threshold", "Select top1_prob_weighted threshold:", 
                  min = 0.4, max = 1.0, value = 0.85, step = 0.01)
    ),
    mainPanel(
      plotOutput("barPlot"),
      verbatimTextOutput("counts")
    )
  )
)

# Define server logic
server <- function(input, output) {
  
  # Reactive dataset based on threshold
  filtered_data <- reactive({
    tmp_platform_camera <- platform_camera %>%
      mutate(transect = as.character(transect)) %>%
      mutate(transect = paste0("T", transect)) %>%
      filter(!grepl("none_", top1)) %>%
      filter(top1_prob_weighted > input$threshold) %>%
      group_by(location, transect, top1) %>%
      summarise(Count = n(), .groups = "drop") %>%
      mutate(Site_type = NA) %>%
      dplyr::select(Site = location, Site_type, Transect = transect, Category = top1, Count)
    
    tmp_pan_family$Method <- "bowl_trap"
    tmp_platform_camera$Method <- "platform_camera"
    
    tmp_combined <- rbind(tmp_pan_family, tmp_platform_camera) %>%
      mutate(Site_type = ifelse(Site %in% c("DES", "HLI", "JEP", "STP", "WUP"), 
                                "reference", "young_restored"))
    
    return(tmp_combined)
  })
  
  # Render plot
  output$barPlot <- renderPlot({
    ggplot(filtered_data(), aes(x = Site, y = Count, fill = Category)) +
      geom_bar(stat = "identity", position = "stack") +
      facet_wrap(~Method) +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
      labs(title = "Comparison of the two sampling methods",
           x = "Site",
           y = "Count") +
      scale_fill_manual(values = custom25)
  })
  
  # Show sum of counts for each method
  output$counts <- renderText({
    data <- filtered_data()
    bowl_count <- sum(data$Count[data$Method == "bowl_trap"], na.rm = TRUE)
    platform_count <- sum(data$Count[data$Method == "platform_camera"], na.rm = TRUE)
    paste("Total Count (Bowl Trap):", bowl_count, "\nTotal Count (Platform Camera):", platform_count)
  })
}

# Run the application 
shinyApp(ui = ui, server = server)
```

```{r}
#remove all dataframes with tmp_ prefix
rm(list = ls(pattern = "^tmp_"))
```

## 4. Automated methods - PLATFORM CAMERAS

### 4.1. Data preparation

```{r}
str(platform_camera)

platform_camera <- platform_camera %>%
  #transect values from numbers 1-5 to T1-T5
  mutate(transect = as.character(transect)) %>%
  mutate(transect = paste0("T", transect))%>%
  #filter out top1 that start with none_ as they are not real taxa
  filter(!grepl("none_", top1))

platform_camera1 <- platform_camera %>%
  #right date format
  mutate(date = as.Date(date, format = "%Y-%m-%d"))%>%
  #join the envir_data with platform_camera
  left_join(envir_data, by = c("location"="Site","transect" ="Transect", "date"="Date"))%>%
  #remove extra columns
  dplyr::select(-Time_category, -Days_since_start)

```


## 5. Automated methods - FLOWER CAMERAS

### 5.1. Data preparation

```{r structure}
#change format of "time" column from hh-mm-ss to hh:mm:ss
flower_camera <- flower_camera %>%
  mutate(time = gsub("\\-", ":", time)) %>%  # Replace '-' with ':'
  mutate(time = chron::times(time))%>%  # Convert to time-only format
  #change format of "date" 
  mutate(date = as.Date(date, format = "%Y-%m-%d"))

str(flower_camera)
```


```{r all data from flower cameras}
custom193 <- paletteer_c("ggthemes::Sunset-Sunrise Diverging", n = 193)

# Replace "other_families" with gray
custom193_named <- setNames(custom193, sort(unique(flower_camera$Classification_Category)))
custom193_named["other_families"] <- "gray50"  # Adjust shade if needed

#plot of the number of each taxon caught in the flower cameras per site
flower_camera %>%
  #summarise per site and count the number of each taxon caught
  group_by(site, Classification_Category) %>%
  summarise(Count = n(), .groups = "drop") %>%
  
  ggplot(aes(x = site, y = Count, fill = Classification_Category)) +
  geom_bar(stat = "identity") +
  labs(title = "Count of each taxon caught with flower cameras per site",
       x = "Site",
       y = "Number of detections") +
  theme(legend.position = "none") +
  scale_fill_manual(values = custom193_named)   # Apply manually
```
```{r threshold adjustment plotting}
#remove rows with Classification_Category "other_families"
flower_camera <- flower_camera %>%
 #filter out the rows where Classification_Category is "other_families"
  filter(Classification_Category != "other_families")
  
  
## Define THRESHOLD ----
TH <- 0.5

#histogram of the Family_Confidence
flower_camera %>%
  ggplot(aes(x = Family_Confidence)) +
  geom_histogram(binwidth = 0.05, fill = "lightblue", color = "black") +
  labs(title = "Histogram of Family Confidence",
       x = "Family Confidence",
       y = "Count")+
  #add a vertical line at the threshold
  geom_vline(xintercept = TH, color = "red", linetype = "dashed")+  
  # Add confidence threshold annotation
  annotate("text", x = Inf, y = Inf, label = paste("Confidence threshold:", TH), 
           hjust = 1.1, vjust = 1.1, size = 3, color = "red")

#new dataframe above TH
flower_camera_light <- flower_camera %>%
  #remove path column
  dplyr::select(-Image_Path) %>%
  #filter out the rows where Family_Confidence is below the threshold
  filter(Family_Confidence > TH) %>% 
  #fill Site_type column with reference or young_restored
  mutate(Site_type = ifelse(site %in% c("DES", "HLI", "JEP", "STP", "WUP"), "reference", "young_restored"))
  
#calculate the proportion of rows removed
diff <- nrow(flower_camera) - nrow(flower_camera_light)
prop <- diff / nrow(flower_camera) 

#print 
print(paste("By removing rows with a probality score below the threshold", TH, ", we remove", round(prop,2), "of the data."))
#remove 
rm(diff, prop)

#plot of the number of each taxon caught in the flower cameras per site
flower_camera_light %>%
  #summarise per site and count the number of each taxon caught
  group_by(site, Classification_Category) %>%
  summarise(Count = n(), .groups = "drop") %>%
  
  ggplot(aes(x = site, y = Count, fill = Classification_Category)) +
  geom_bar(stat = "identity") +
  labs(title = "Count of each taxon caught in flower cameras per site",
       x = "Site",
       y = "Number of individuals caught") +
  theme(legend.position = "none") +
  scale_fill_manual(values = custom193_named)  +  
  # Add confidence threshold annotation
  annotate("text", x = Inf, y = Inf, label = paste("Probability threshold:", TH), 
           hjust = 1.1, vjust = 1.1, size = 3)

#plot of the number of each taxon caught in per flower species 
flower_camera_light %>%
  #summarise per site and count the number of each taxon caught
  group_by(site, Classification_Category, flower_sp) %>%
  summarise(Count = n(), .groups = "drop") %>%
  
  ggplot(aes(x = flower_sp, y = Count, fill = Classification_Category)) +
  geom_bar(stat = "identity") +
  labs(title = "Count of each taxon caught in flower cameras per flower species",
       x = "Flower Species",
       y = "Number of detections") +
  theme(legend.position = "none") +
  #slant the x-axis labels
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_manual(values = custom193_named) +  
  # Add confidence threshold annotation
  annotate("text", x = Inf, y = Inf, label = paste("Probability threshold:", TH), 
           hjust = 1.1, vjust = 1.1, size = 3)
```

### 5.2. Data exploration - Individuals vs time

```{r individuals vs time}
#plot of the number of individuals caught in the flower cameras over time
# Convert time to POSIXct by combining with the date
binned_data <- flower_camera_light %>%
  mutate(
    datetime = as.POSIXct(paste(date, time), format = "%Y-%m-%d %H:%M:%S"),  # Ensure proper datetime format
    time_bin = floor_date(datetime, "10 minutes"))%>%  # Bin into 5-minute chunks
  #remove date from the time_bin column
  mutate(time_bin = format(time_bin, "%H:%M:%S"))

# Summarize count of individuals per order per time bin
binned_data <- binned_data %>%
  group_by(date,site,time_bin, Order) %>%
  summarise(Count = n(), .groups = "drop")%>%
  #change time_bin to a character
  mutate(time_bin = as.character(time_bin))

# Plot the data
ggplot(binned_data, aes(x = time_bin, y = Count, fill = Order)) +
  geom_bar(stat = "identity")+
  labs(
    title = "Number of Individuals Per Family Over Time (10-min Bins)",
    x = "Time (10-minute bins)",
    y = "Count of Individuals"
  ) +
  facet_wrap(~site) +
  theme_minimal() +
  theme(legend.position = "right")+
  # format x-axis to show labels every hour
  scale_x_discrete(
      breaks = binned_data$time_bin[grepl("00:00$|30:00$", binned_data$time_bin)],
      labels = gsub(":00$", "", binned_data$time_bin[grepl("00:00$|30:00$", binned_data$time_bin)]))+
  #slant the x-axis labels
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) 
  #scale_color_manual(values = custom193_named)   # Apply manually

#rm(binned_data)
```



### 5.3. Data exploration - Daucus carota

Here, we'll focus on the Daucus carota species, as it is a common plant species in the study area and is known to attract a variety of pollinators. 

Since the cameras didn't have an ID tracking system, we'll have a look at taxonomic richness and relative abundance of pollinators attracted to Daucus carota.

```{r daucus carota both methods}
daucus_cam <- flower_camera_light %>%
  #filter out the rows where the flower species is Daucus.carota
  filter(flower_sp == "Daucus carota") %>%
  group_by(site) %>%
  summarise(unique_families = unique(Classification_Category),
            .groups = "drop")%>%
  #add Count column filled with 1 
  mutate(Count = 1)

#same thing with netting
daucus_net <- netting %>%
  #filter out the rows where the flower species is Daucus.carota
  filter(plant_species == "Daucus carota") %>%
  group_by(site) %>%
  summarise(unique_families = unique(family),
            .groups = "drop")%>%
  #add Count column filled with 1 
  mutate(Count = 1)

# Combine both datasets, adding a column to differentiate methods
daucus <- bind_rows(
  daucus_cam %>% mutate(method = "Camera"),
  daucus_net %>% mutate(method = "Net")
)

#combining all the unique families caught on Daucus with nets and cameras
fams <- sort(unique(daucus$unique_families));length(fams) # Get unique families sorted alphabetically
customfam <- paletteer_c("pals::kovesi.rainbow_bgyrm_35_85_c69", n = length(fams))
customfam <- setNames(customfam, fams)

# Create a single ggplot with faceting
final_plot1 <- ggplot(daucus, aes(x = site, y = Count, fill = unique_families)) +
  geom_bar(stat = "identity") +
  facet_wrap(~method, ncol = 1) +  # Separate plots
  labs(title = "Pollinator Family richness caught on Daucus carota",
       x = "Site",
       y = "Number of unique families caught") +
  theme(legend.position = "none") +  # Shared legend at bottom
  scale_fill_manual(values = customfam)  # Consistent colors

# Create a single ggplot with faceting
final_plot2 <- ggplot(daucus, aes(x = method, y = Count, fill = unique_families)) +
  geom_bar(stat = "identity") +
  labs(title = "Pollinator Family richness caught on Daucus carota",
       x = "Site",
       y = "Number of unique families caught") +
  theme(legend.position = "none") +  # Shared legend at bottom
  scale_fill_manual(values = customfam)  # Consistent colors

# Print the final plot
print(final_plot1); print(final_plot2)
```

```{r}
rm(daucus_cam, daucus_net, fams, customfam, final_plot1, final_plot2)
```

## Modelling

*Key Metric	Meaning*    

- AICc (Akaike Information Criterion, corrected)	Measures model fit while penalizing complexity. Lower = better.
- BIC (Bayesian Information Criterion)	Similar to AIC but penalizes complexity more harshly. Lower = better.
- R² (Conditional & Marginal)	Measures variance explained by fixed & random effects. Higher = better.
- ICC (Intraclass Correlation Coefficient)	Proportion of variance explained by random effects. Higher = more site-level variation.
- RMSE (Root Mean Square Error)	Measures prediction error. Lower = better.

## Model building - Flower survey data

```{r fig.width=8, fig.height=10}
scaled_envir_data <-envir_data %>%
  
  #z transform the numerical columns, except Floral_simpson_index
  mutate(across(where(is.numeric) & !contains("Floral_simpson_index"), scale))

#checking the values
scaled_envir_data%>%
  mutate(across(where(is.numeric)))%>%
  #summary()%>%
  sapply(sd)
  
scaled_envir_data%>%
  ggplot(aes(x=Floral_simpson_index))+
  geom_histogram(binwidth = 0.1, fill = "lightblue", color = "black")+
  labs(title = "Histogram of Floral Simpson Index",
       x = "Floral Simpson Index",
       y = "Count")

# Create a linear model
# full model with Floral_simpson_index as response variable and structure around  the sites as explanatory variables, and site as random effect
plantsimp_mod1_full <- lmer(Floral_simpson_index ~ majority_class + Site_type + (1|Site), data = scaled_envir_data)

summary(plantsimp_mod1_full)
parameters(plantsimp_mod1_full)

#checking the model
#check_model(plantsimp_mod1_full)

#overdispersion
check_overdispersion(plantsimp_mod1_full)

#collinearity
check_collinearity(plantsimp_mod1_full)

# Compute fitted values and Pearson residuals
plantsimp_mod1_vals <- fitted(plantsimp_mod1_full)
plantsimp_mod1_residuals <- residuals(plantsimp_mod1_full, type = "pearson")
# Create binned residuals plot
arm::binnedplot(plantsimp_mod1_vals, plantsimp_mod1_residuals)

#DHARMa package - simulate residuals and check model assumptions
plantsimp_mod1_sim_res <- simulateResiduals(fittedModel = plantsimp_mod1_full)
plot(plantsimp_mod1_sim_res)
```





Variable	  Estimate	  Std. Error	t-value	  Interpretation
(Intercept)	0.6233	    0.2175	     2.865	  Baseline Floral Simpson Index when all predictors are at their mean.
agri	      -882.06	    4542.82	    -0.194  	Agriculture has a weak negative effect, but it is not significant.
grass	      -826.37	    4256.14	    -0.194  	Grassland has a weak negative effect, but it is not significant.
snh       	-121.56	    625.75	    -0.194  	Semi-natural habitat has a weak negative effect, but not significant.
forest    	-674.38	    3473.38	    -0.194  	Forest has a weak negative effect, but not significant.
urban	      -557.58	    2872.05	    -0.194  	Urban area has a weak negative effect, but not significant.
water     	-197.66	    1017.87	    -0.194  	Water has a weak negative effect, but not significant.
Site_type 	0.1349	    0.4736	     0.285  	Young restored sites have a slightly higher Simpson Index, but not significantly so.
(young_restored)

# Flower Survey Model Interpretation of Results
The linear mixed model (LMM) was appropriate for this data, as it accounted for random site effects. 
Assumptions were met: residuals were approximately normal, there was no overdispersion (dispersion ratio = 0.835, p = 0.536), and multicollinearity was low (VIF ~ 1.67). 
The fixed effects showed no significant impact of majority land cover class (forest, grass, or urban) or site type (young restored) on floral Simpson index. 
  - No majority class significantly affects floral diversity, meaning different land covers (forest, grass, urban) do not have a strong influence on floral Simpson Index in this dataset. 
  - The restoration stage does not significantly influence floral diversity.



## Model building - netting data

```{r prepare data}
#scale the last envir_data - Floral simpson_index
scaled_envir_data <- envir_data %>%
  #z transform the numerical columns, except Floral_simpson_index
  mutate(across(where(is.numeric), scale))

netting1 <- netting %>%
  #right date format
  mutate(date = as.Date(date, format = "%Y-%m-%d"))%>%
  #summarize by site, transect
  group_by(site, transect) %>%
  summarise(total_interaction_T = sum(total_interaction), .groups = "drop")%>%
   #join the envir_data with netting
  left_join(scaled_envir_data, by = c("site"="Site", "transect"="Transect"))

#histogram of total_interaction_T
netting1 %>%
  ggplot(aes(x = total_interaction_T)) +
  geom_histogram(fill = "lightblue", color = "black") +
  labs(title = "Histogram of Netting Counts",
       x = "total interactions",
       y = "Count")
```
## Netting - POISSON GLMM

### Netting model 1 - poisson with all predictors

```{r netting_mod1_full, fig.width=8, fig.height=10}
# full model with interaction counts as response variable and environmental, weather and plant diversity variables as explanatory variables, and site as random effect
#Poisson distribution 
netting_mod1_full <- glmer(total_interaction_T 
                           ~ Floral_simpson_index 
                           + Time_category
                           + top2_ratio
                           + Site_type
                           + dm_wind_velocity
                           + dm_temperature
                           #+  majority_class
                           #+ urban + agri + grass + snh + forest + water
                          + Days_since_start
                           + (1|site), 
                           data = netting1, family = "poisson")

summary(netting_mod1_full)
parameters(netting_mod1_full)

#check the model
check_model(netting_mod1_full)

#overdispersion
check_overdispersion(netting_mod1_full)

#collinearity
check_collinearity(netting_mod1_full)

# Compute fitted values and Pearson residuals
netting_mod1_vals <- fitted(netting_mod1_full)
netting_mod1_residuals <- residuals(netting_mod1_full, type = "pearson")
# Create binned residuals plot
arm::binnedplot(netting_mod1_vals, netting_mod1_residuals)

#DHARMa package - simulate residuals and check model assumptions
netting_mod1_sim_res <- simulateResiduals(fittedModel = netting_mod1_full)
plot(netting_mod1_sim_res)
```

This first model has too many predictors and is overfitting the data. 
A lot of the predictors are significant, but the assumptions of the model are not met (overdispersion(p < 0.001), S-shape around qqplot, and the residuals appear to be heteroskedastic (residuals vs predicted plot)). 
We will be removing predictors one by one and checking the model assumptions after each step. 

### Netting model 2 - poisson -dm_temperature

For the second model, the daily mean tempreature is removed, because it had the highest p-value (0.741) and was not significant.
dm temperature             |     0.02 | 0.07 | [-0.11,  0.16] |  0.33 | 0.741 

```{r netting_mod2_full, fig.width=8, fig.height=10}
# full model with interaction counts as response variable and environmental, weather and plant diversity variables as explanatory variables, and site as random effect 
# removing dm_temperature
netting_mod2_full <- glmer(total_interaction_T 
                           ~ Floral_simpson_index 
                           + Time_category
                           + top2_ratio
                           + Site_type
                           + dm_wind_velocity
                           #+ dm_temperature
                           #+  majority_class
                           #+ urban + agri + grass + snh + forest + water
                           + Days_since_start
                           + (1|site), 
                           data = netting1, family = "poisson")

summary(netting_mod2_full)
parameters(netting_mod2_full)

#check the model
check_model(netting_mod2_full)

#overdispersion
check_overdispersion(netting_mod2_full)
#collinearity
check_collinearity(netting_mod2_full)

# Compute fitted values and Pearson residuals
netting_mod2_vals <- fitted(netting_mod2_full)
netting_mod2_residuals <- residuals(netting_mod2_full, type = "pearson")
# Create binned residuals plot
arm::binnedplot(netting_mod2_vals, netting_mod2_residuals)

#DHARMa package - simulate residuals and check model assumptions
netting_mod2_sim_res <- simulateResiduals(fittedModel = netting_mod2_full)
plot(netting_mod2_sim_res)
```

There are still too many predictors and some issues with the model assumptions. 
 
 
### Netting model 3 - poisson - dm_temperature and days since start

Removing the days since start, because it had the highest p-value and was not significant:   
Days_since_start         0.11976    0.06882   1.740  0.08181 .  

 
```{r netting_mod3_full, fig.width=8, fig.height=10}
# full model with interaction counts as response variable and environmental, weather and plant diversity variables as explanatory variables, and site as random effect
# removing days since start
netting_mod3_full <- glmer(total_interaction_T 
                           ~ Floral_simpson_index 
                           + Time_category
                           + top2_ratio
                           + Site_type
                           + dm_wind_velocity
                           #+ dm_temperature
                           #+  majority_class
                           #+ urban + agri + grass + snh + forest + water
                          #+ Days_since_start
                           + (1|site), 
                           data = netting1, family = "poisson")

summary(netting_mod3_full)
parameters(netting_mod3_full)

#check the model
check_model(netting_mod3_full, verbose = T)

#overdispersion
check_overdispersion(netting_mod3_full)

#collinearity
check_collinearity(netting_mod3_full)

# Compute fitted values and Pearson residuals
netting_mod3_vals <- fitted(netting_mod3_full)
netting_mod3_residuals <- residuals(netting_mod3_full, type = "pearson")

# Create binned residuals plot
arm::binnedplot(netting_mod3_vals, netting_mod3_residuals)

#DHARMa package - simulate residuals and check model assumptions
netting_mod3_sim_res <- simulateResiduals(fittedModel = netting_mod3_full)
plot(netting_mod3_sim_res)
```

#### netting_mod3_full
netting_mod3_full <- glmer(total_interaction_T 
                           ~ Floral_simpson_index 
                           + Time_category
                           + top2_ratio
                           + Site_type
                           + dm_wind_velocity
                           + (1|site), 
                           data = netting1, family = "poisson")
*Model summary:*
- has 5 predictors and one random effect
- has a significant effect of the floral simpson index (p < 0.001), time category (p < 0.001), top2_ratio (p < 0.001), has a significant effect of dm_wind_velocity (p = 0.014 )
- has a marginal effect of site type (p = 0.051)

*Model assumptions:*
- Over dispersion was detected (p < 0.001) with the performance package check_overdispersion()
    + another model could be used - *negative binomial*
    + the DHARMa qqplot showed the same pattern - dispersion is not normal (p < 0.001)
- the DHARMa qqplot also indicated significant outliers. 
- Correlation is low between predictors (VIF < 2) with the performance package check_collinearity()
- The binned residuals plot from the arm package shows no clear trend.

```{r netting_mod4_full, fig.width=8, fig.height=10}
# full model with interaction counts as response variable and environmental, weather and plant diversity variables as explanatory variables, and site as random effect
# removing site_type

netting_mod4_full <- glmer(total_interaction_T 
                           ~ Floral_simpson_index 
                           + Time_category
                           + top2_ratio
                           #+ Site_type
                           + dm_wind_velocity
                           #+ dm_temperature
                           #+  majority_class
                           #+ urban + agri + grass + snh + forest + water
                          #+ Days_since_start
                           + (1|site), 
                           data = netting1, family = "poisson")

summary(netting_mod4_full)
parameters(netting_mod4_full)

#check the model
check_model(netting_mod4_full, verbose = T)

#overdispersion
check_overdispersion(netting_mod4_full)

#collinearity
check_collinearity(netting_mod4_full)

# Compute fitted values and Pearson residuals
netting_mod4_vals <- fitted(netting_mod4_full)
netting_mod4_residuals <- residuals(netting_mod4_full, type = "pearson")

# Create binned residuals plot
arm::binnedplot(netting_mod4_vals, netting_mod4_residuals)

#DHARMa package - simulate residuals and check model assumptions
netting_mod4_sim_res <- simulateResiduals(fittedModel = netting_mod4_full)
plot(netting_mod4_sim_res)
```
### Compare the models with the performance package
```{r}
# Compare the models with the performance package
net_pois_comp1 <- compare_performance(netting_mod1_full, netting_mod2_full, netting_mod3_full, netting_mod4_full,  
                                        metrics = c("AICc", "BIC", "R2", "ICC", "RMSE"))

# Print the comparison table
print(net_pois_comp1)
```

The comparison of the models shows that the model with the lowest AICc and BIC is the third model (netting_mod3_full), which has the lowest AICc and BIC values. However, even in this model, the AICc and BIC values are quite high, indicating that the model is not the best fit for the data. In the next step, we will try to run a negative binomial model to see if it improves the fit of the model.


## Netting - NEGATIVE BINOMIAL GLMM

### Netting model 1 - negative binomial with all predictors 

We start again with the full model, but this time we use a negative binomial distribution.

```{r netting_mod1_NB, fig.width=8, fig.height=10}
# full model with interaction counts as response variable and environmental, weather and plant diversity variables as explanatory variables, and site as random effect
# negative binomial distribution

netting_mod1_NB <- glmer.nb(total_interaction_T 
                            ~ Floral_simpson_index 
                            + Time_category
                            + top2_ratio
                            + Site_type
                            + dm_wind_velocity
                            + dm_temperature
                            #+  majority_class
                            #+ urban + agri + grass + snh + forest + water
                            + Days_since_start
                            + (1|site), 
                            data = netting1, 
                            family = nbinom2)

summary(netting_mod1_NB)
parameters(netting_mod1_NB)
  
#check the model
check_model(netting_mod1_NB, verbose = T)

#overdispersion
check_overdispersion(netting_mod1_NB)
#collinearity
check_collinearity(netting_mod1_NB)

# Compute fitted values and Pearson residuals
netting_mod1_NB_vals <- fitted(netting_mod1_NB)
netting_mod1_NB_residuals <- residuals(netting_mod1_NB, type = "pearson")

# Create binned residuals plot
arm::binnedplot(netting_mod1_NB_vals, netting_mod1_NB_residuals)

#DHARMa package - simulate residuals and check model assumptions
netting_mod1_NB_sim_res <- simulateResiduals(fittedModel = netting_mod1_NB)
plot(netting_mod1_NB_sim_res)
```

With this model, the assumptions are met (qqplot is normal, no overdispersion, and the residuals are homoscedastic). There are still too many predictors for the amount of data we have, so we will remove the predictors one by one and check the model assumptions after each step.

 
```{r netting_mod2_NB, fig.width=8, fig.height=10}

# full model with interaction counts as response variable and environmental, weather and plant diversity variables as explanatory variables, and site as random effect
# remove time_category (p= 0.442 for netting_mod1_NB)

netting_mod2_NB <- glmer.nb(total_interaction_T 
                           ~ Floral_simpson_index 
                           #+ Time_category
                           + top2_ratio
                           + Site_type
                           + dm_wind_velocity
                           + dm_temperature
                           #+  majority_class
                           #+ urban + agri + grass + snh + forest + water
                           + Days_since_start
                           + (1|site), 
                           data = netting1,
                           family = nbinom2)

summary(netting_mod2_NB)
parameters(netting_mod2_NB)

#check the model
check_model(netting_mod2_NB, verbose = T)
#overdispersion
check_overdispersion(netting_mod2_NB)
#collinearity
check_collinearity(netting_mod2_NB)

# Compute fitted values and Pearson residuals
netting_mod2_NB_vals <- fitted(netting_mod2_NB)
netting_mod2_NB_residuals <- residuals(netting_mod2_NB, type = "pearson")

# Create binned residuals plot
arm::binnedplot(netting_mod2_NB_vals, netting_mod2_NB_residuals)
#DHARMa package - simulate residuals and check model assumptions
netting_mod2_NB_sim_res <- simulateResiduals(fittedModel = netting_mod2_NB)
plot(netting_mod2_NB_sim_res)

```

```{r netting_mod3_NB, fig.width=8, fig.height=10} 
# full model with interaction counts as response variable and environmental, weather and plant diversity variables as explanatory variables, and site as random effect
# remove days since start ( p= 0.333 for netting_mod2_NB)

netting_mod3_NB <- glmer.nb(total_interaction_T 
                           ~ Floral_simpson_index 
                           #+ Time_category
                           + top2_ratio
                           + Site_type
                           + dm_wind_velocity
                           + dm_temperature
                           #+  majority_class
                           #+ urban + agri + grass + snh + forest + water
                           #+ Days_since_start
                           + (1|site), 
                           data = netting1,
                           family = nbinom2)

summary(netting_mod3_NB)
parameters(netting_mod3_NB)

#check the model
check_model(netting_mod3_NB, verbose = T)
#overdispersion
check_overdispersion(netting_mod3_NB)
#collinearity
check_collinearity(netting_mod3_NB)

# Compute fitted values and Pearson residuals
netting_mod3_NB_vals <- fitted(netting_mod3_NB)
netting_mod3_NB_residuals <- residuals(netting_mod3_NB, type = "pearson")

# Create binned residuals plot
arm::binnedplot(netting_mod3_NB_vals, netting_mod3_NB_residuals)
#DHARMa package - simulate residuals and check model assumptions
netting_mod3_NB_sim_res <- simulateResiduals(fittedModel = netting_mod3_NB)
plot(netting_mod3_NB_sim_res)

```

```{r netting_mod4_NB, fig.width=8, fig.height=10}
# full model with interaction counts as response variable and environmental, weather and plant diversity variables as explanatory variables, and site as random effect
# remove dm temperature (p= 0.2486 for netting_mod3_NB)
netting_mod4_NB <- glmer.nb(total_interaction_T 
                           ~ Floral_simpson_index 
                           #+ Time_category
                           + top2_ratio
                           + Site_type
                           + dm_wind_velocity
                           #+ dm_temperature
                           #+  majority_class
                           #+ urban + agri + grass + snh + forest + water
                           #+ Days_since_start
                           + (1|site), 
                           data = netting1, 
                           family = nbinom2)

summary(netting_mod4_NB)
parameters(netting_mod4_NB)

```


### Compare the NB models with the performance package

```{r}
# Compare the models with the performance package
net_NB_comp1 <- compare_performance(netting_mod1_NB, netting_mod2_NB, netting_mod3_NB, netting_mod4_NB,  
                                        metrics = c("AICc", "BIC", "R2", "ICC", "RMSE"))

# Print the comparison table
print(net_NB_comp1)
```
### NB model including landscape data

```{r netting_mod1_land_NB, fig.width=8, fig.height=10}
# full model with interaction counts as response variable and environmental, weather and plant diversity variables as explanatory variables, and site as random effect

netting_mod1_land_NB <- glmer.nb(total_interaction_T 
                            ~ Floral_simpson_index 
                            + Time_category
                            + top2_ratio
                            + Site_type
                            + dm_wind_velocity
                            + dm_temperature
                            #+  majority_class
                            + urban + agri + grass + snh + forest + water
                            + Days_since_start
                            + (1|site), 
                            data = netting1, 
                            family = nbinom2)


summary(netting_mod1_land_NB)
parameters(netting_mod1_land_NB)

```


```{r netting_mod2_land_NB, fig.width=8, fig.height=10}
# full model with interaction counts as response variable and environmental, weather and plant diversity variables as explanatory variables, and site as random effect

# removing snh (p=0.690 for previous model)
netting_mod2_land_NB <- glmer.nb(total_interaction_T 
                            ~ Floral_simpson_index 
                            + Time_category
                            + top2_ratio
                            + Site_type
                            + dm_wind_velocity
                            + dm_temperature
                            #+  majority_class
                            + urban + agri + grass 
                            #+ snh 
                            + forest + water
                            + Days_since_start
                            + (1|site), 
                            data = netting1, 
                            family = nbinom2)


summary(netting_mod2_land_NB)
parameters(netting_mod2_land_NB)

```


```{r netting_mod3_land_NB, fig.width=8, fig.height=10}
# full model with interaction counts as response variable and environmental, weather and plant diversity variables as explanatory variables, and site as random effect

# removing forest (p= 0.963324 for previous model)
netting_mod3_land_NB <- glmer.nb(total_interaction_T 
                            ~ Floral_simpson_index 
                            + Time_category
                            + top2_ratio
                            + Site_type
                            + dm_wind_velocity
                            + dm_temperature
                            #+  majority_class
                            + urban + agri + grass 
                            #+ snh 
                            #+ forest 
                            + water
                            + Days_since_start
                            + (1|site), 
                            data = netting1, 
                            family = nbinom2)


summary(netting_mod3_land_NB)
parameters(netting_mod3_land_NB)

```

```{r netting_mod4_land_NB, fig.width=8, fig.height=10}
# full model with interaction counts as response variable and environmental, weather and plant diversity variables as explanatory variables, and site as random effect
# removing days since start (p= 0.963  for previous model)

netting_mod4_land_NB <- glmer.nb(total_interaction_T 
                            ~ Floral_simpson_index 
                            + Time_category
                            + top2_ratio
                            + Site_type
                            + dm_wind_velocity
                            + dm_temperature
                            #+  majority_class
                            + urban + agri + grass 
                            #+ snh 
                            #+ forest 
                            + water
                            #+ Days_since_start
                            + (1|site), 
                            data = netting1, 
                            family = nbinom2)

summary(netting_mod4_land_NB)
parameters(netting_mod4_land_NB)

```

```{r netting_mod5_land_NB, fig.width=8, fig.height=10}
# full model with interaction counts as response variable and environmental, weather and plant diversity variables as explanatory variables, and site as random effect
# removing Floral_simpson_index (p= 0.479 for previous model)

netting_mod5_land_NB <- glmer.nb(total_interaction_T 
                            #~ Floral_simpson_index 
                            ~ Time_category
                            + top2_ratio
                            + Site_type
                            + dm_wind_velocity
                            + dm_temperature
                            #+  majority_class
                            + urban + agri + grass 
                            #+ snh 
                            #+ forest 
                            + water
                            #+ Days_since_start
                            + (1|site), 
                            data = netting1, 
                            family = nbinom2)

summary(netting_mod5_land_NB)
parameters(netting_mod5_land_NB)

```

```{r netting_mod6_land_NB, fig.width=8, fig.height=10}
# full model with interaction counts as response variable and environmental, weather and plant diversity variables as explanatory variables, and site as random effect
# removing dm wind velocity  (p= 0.284 for previous model)

netting_mod6_land_NB <- glmer.nb(total_interaction_T 
                            #~ Floral_simpson_index 
                            #+ Time_category
                            ~ top2_ratio
                            + Site_type
                            #+ dm_wind_velocity
                            + dm_temperature
                            #+  majority_class
                            + urban + agri + grass 
                            #+ snh 
                            #+ forest 
                            + water
                            #+ Days_since_start
                            + (1|site), 
                            data = netting1, 
                            family = nbinom2)

summary(netting_mod6_land_NB)
parameters(netting_mod6_land_NB)

```

```{r netting_mod7_land_NB, fig.width=8, fig.height=10}
#remove dm temperature  p= 0.744    in previous model 

netting_mod7_land_NB <- glmer.nb(total_interaction_T 
                            #~ Floral_simpson_index 
                            #+ Time_category
                            ~ top2_ratio
                            + Site_type
                            #+ dm_wind_velocity
                            #+ dm_temperature
                            #+  majority_class
                            + urban + agri + grass 
                            #+ snh 
                            #+ forest 
                            + water
                            #+ Days_since_start
                            + (1|site), 
                            data = netting1, 
                            family = nbinom2)
summary(netting_mod7_land_NB)
parameters(netting_mod7_land_NB)

check_model(netting_mod7_land_NB, verbose = T)

#overdispersion
check_overdispersion(netting_mod7_land_NB)
#collinearity
check_collinearity(netting_mod7_land_NB)

# Compute fitted values and Pearson residuals
netting_mod7_land_NB_vals <- fitted(netting_mod7_land_NB)
netting_mod7_land_NB_residuals <- residuals(netting_mod7_land_NB, type = "pearson")
# Create binned residuals plot
arm::binnedplot(netting_mod7_land_NB_vals, netting_mod7_land_NB_residuals)

#DHARMa package - simulate residuals and check model assumptions
netting_mod7_land_NB_sim_res <- simulateResiduals(fittedModel = netting_mod7_land_NB)
plot(netting_mod7_land_NB_sim_res)
```

### Compare the models with the performance package

```{r}
# Compare the models with the performance package
net_NB_comp2 <- compare_performance(netting_mod1_land_NB, netting_mod2_land_NB, netting_mod3_land_NB, netting_mod4_land_NB, 
                                      netting_mod5_land_NB, netting_mod6_land_NB, netting_mod7_land_NB,
                                        metrics = c("AICc", "BIC", "R2", "ICC", "RMSE"))

# Print the comparison table
print(net_NB_comp2)

```

