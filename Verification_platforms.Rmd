---
title: "Verification_platforms"
author: "Alma Steireif"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(viridis)
```


# Load .csv data generated by the Tkinter script 
```{r}
data <- read.csv("C:/Users/Almas/bioclip_test/MadHornet/verification_results3.csv", header=F, sep=",")
#adding column names
colnames(data) <- c("path", "category", "filename","verification","elapsed_time") #elasped time in seconds 0.00
```


# Data preparation
```{r}
#removing extra columns
data <- data %>%
  #replace elapsed time that are >30 sec with NA
  mutate(elapsed_time = ifelse(elapsed_time > 30, NA, elapsed_time))

data$category <- as.factor(data$category)

time_data <- data %>%
 #average time and n per category
  group_by(category) %>%
  summarise(mean_time = mean(elapsed_time, na.rm = TRUE),
            n = n()) %>%
  arrange(mean_time)

sum(time_data$n);sum(data$elapsed_time, na.rm = TRUE)/60
```
# ID splitting
Every filename has a structure like this: 2024-07-29_14-23-01-069525_ID1411_crop.jpg, with yyyy-mm-dd_hh-mm-ss-sss_IDxxxx_crop.jpg. The ID is the last part of the filename, which is separated by an underscore.
I want to split the ID from the filename and create a new column with the ID and a column with the date.

```{r}
#splitting the ID and the date yyyy-mm-dd from the filename
data <- data %>%
  mutate(ID = str_extract(filename, "ID[0-9]+"),
         date = str_extract(filename, "[0-9]{4}-[0-9]{2}-[0-9]{2}"))

#combine rows that have the same ID and date, sum the n column and the elapsed_time
data_unique_ID <- data %>%
  group_by(ID, date) %>%
  summarise(
    category = names(sort(table(category), decreasing = TRUE))[1],  # Select most frequent category 
    verification = first(verification),
    elapsed_time = sum(elapsed_time, na.rm = TRUE),
    n = n(),
    .groups = "drop"
  ) %>%
  arrange(ID)

```

# Precision metrics

Precision is the fraction of relevant instances among the retrieved instances. It is defined as:
correctly identified instances (correct) / total number of instances identified (n)
= true positives / (true positives + false positives)
```{r}
#precision metrics
precision <- data %>%
  group_by(category) %>%
  summarise(correct = sum(verification == "Correct"),
            n = n()) %>%
  mutate(precision = correct/n) %>%
  arrange(precision)

precision_ID <- data_unique_ID %>%
  group_by(category) %>%
  summarise(correct = sum(verification == "Correct"),
            n = n()) %>%
  mutate(precision = correct/n) %>%
  arrange(precision)
```



# Plotting
```{r}
#plotting and ordering by precision score reorder() in viridis palette
ggplot(precision, aes(x = reorder(category, precision), y = precision, fill = precision)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis(option = "plasma", direction=-1) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Precision score per category",
       x = "Category",
       y = "Precision score") +
  geom_text(aes(label = round(precision, 2)), vjust = -0.5, size = 3) +
  theme(legend.position = "none")

# unique ID: plotting and ordering by precision score reorder() in viridis palette
ggplot(precision_ID, aes(x = reorder(category, precision), y = precision, fill = precision)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis(option = "plasma", direction=-1) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Precision score per category (unique ID)",
       x = "Category",
       y = "Precision score") +
  geom_text(aes(label = round(precision, 2)), vjust = -0.5, size = 3) +
  theme(legend.position = "none")

#plot time data
ggplot(time_data, aes(x = reorder(category, mean_time), y = mean_time, fill = mean_time)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis(option = "plasma", direction=-1) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Average time per category",
       x = "Category",
       y = "Average time (s)") +
  geom_text(aes(label = round(mean_time, 2)), vjust = -0.5, size = 3) +
  theme(legend.position = "none")

#stacked barplot with correct and incorrect verifications
ggplot(data, aes(x = category, fill = verification)) +
  geom_bar() +
  scale_fill_viridis(discrete = TRUE) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Correct and incorrect verifications per category",
       x = "Category",
       y = "Count") +
  theme(legend.position = "top")

#unique ID: stacked barplot with correct and incorrect verifications
ggplot(data_unique_ID, aes(x = category, fill = verification)) +
  geom_bar() +
  scale_fill_viridis(discrete = TRUE) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Correct and incorrect verifications per category (unique ID)",
       x = "Category",
       y = "Count") +
  theme(legend.position = "top")

```