---
title: "plant_diversity"
author: "Alma Steireif"
date: "`r Sys.Date()`"
output:
  html_document:
      toc: TRUE
---

Author: Alma Steireif
Date: `r Sys.Date()`

# 0.0. Description

The goal of this script is to clean and standardize flower coverage data collected from 9 sites in Sachsen-Anhalt. 
The starting variables are: Site, Site_type, Plant_sp, Transect, Plot, Cover_percentage, BB (Braun-Blanquet scale).

One of the major fixes applied to this dataset is the transformation of a mix between flower cover percentage and Braun-Blanquet scale, to two consistent columns: one with percentages of flower cower and one with categories following the Braun-Blanquet scale. 

The data processing steps are structured like this:

A. Site composition differences
To visualize plant species composition between sites and determine whether plant communities significantly differ between restored and reference sites.
    - `NMDS`
    - `PERMANOVA`
    - `ANOSIM`
    - `SIMPER` analysis
   
B.  iNext approach
After transforming the cover percentage to presence/absence data at the plot level, we calculate plant species richness, and estimate plant species diversity using rarefaction curves from the `iNEXT` package.  
    - at the site level
    - pooling: at the site type level (restored vs. reference)

C. Relative cover ratio
 Since working with percentages of the total plot surface is inconvenient to use in packages, we transform the data to relative cover ratios per plot, that way we can calculate diversity indices.
    - The average of flower cover percentage per species per transect is also calculated, to get abundance estimates. 

D. Diversity indices calculation on the relative cover ratio data, with the `vegan` package. 
    - Species richness
    - Shannon diversity index
    - Simpson diversity index
    
E. Plant survey and netting pollinator interaction combined
    - This allows us to see which plants are most visited by pollinators and then create a topx_plant variable that will be used in later analysis

F. Network metrics: This section of this script calculates and plots the network of plant-pollinator interactions from the netting data.
    - The network is visualized using the `igraph` package.
    - Network metrics are calculated to assess the structure and connectivity of the plant-pollinator network.
    


# 0.1. Set up 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(googlesheets4) #package to read google sheets
library(tidyverse) 
library(viridis) #color palette

library(TNRS) # Resolve plant taxonomic names

library(vegan)#package to run metaNMDS

library(iNEXT) #package to run rarefaction curves
library(fossil) 

library(gridExtra) # Arrange multiple plots
library(patchwork) # Arrange multiple plot

plant_data_load <-read_sheet("https://docs.google.com/spreadsheets/d/1YDOoUobRU6A36um0-iut6kY77X0jEMYXtFWR3-Zankc/edit?usp=sharing", sheet=3) #sheet 3 has the plant data
```

```{r custom colors}
#define custom colors for plotting
custom_colors <- c(
  #reference sites
  "DES" = "#7F3B19FF",  
  "HLI" = "#FDB863FF",  
  "JEP" = "#E08214FF",  
  "STP" = "#B35806FF",
  "WUP" = "#F7B059FF",
  # restored sites
  "BUH" = "#93C6E1FF",  
  "KOT" = "#5F93ACFF",  
  "WDG" = "#2E627AFF",  
  "WED" = "#00344AFF"  
)


#corresponding pastel palette for confidence intervals
pastel_colors <- c(
    "DES" = "#FFD1A9",  
    "HLI" = "#FFE6B3",  
    "JEP" = "#FFD699",  
    "STP" = "#FFCC80",
    "WUP" = "#FFE6CC",
    "BUH" = "#CCEBFF",  
    "KOT" = "#B3D9FF",  
    "WDG" = "#99C2FF",  
    "WED" = "#80B0FF"  
  )

# bicolor palette
bicolor_palette <- c(
  "DES" = "darkorange",  
  "HLI" = "darkorange",  
  "JEP" = "darkorange",  
  "STP" = "darkorange",
  "WUP" = "darkorange",
  "BUH" = "steelblue",  
  "KOT" = "steelblue",  
  "WDG" = "steelblue",  
  "WED" = "steelblue" 
)

# Custom color palette
steelorange <- c("Young Restored" = "steelblue", "Reference" = "darkorange", "1-5 y"="steelblue")

bicolor_bg <- c(
  "DES" = "lightyellow",  "HLI" = "lightyellow",  "JEP" = "lightyellow",  "STP" = "lightyellow",  "WUP" = "lightyellow",
  "BUH" = "lightblue1",    "KOT" = "lightblue1",    "WDG" = "lightblue1",    "WED" = "lightblue1")
```


# 1. Data preparation
## 1.1. Selecting columns & cleaning 


```{r selecting columns & cleaning}
plants <- plant_data_load %>%
  select(1:7) %>%
  
  # Rename columns for consistency
  rename(Site_type = Age,  # Change "Age" to "Site_type" for standardization with other scripts
    Plant_sp = `plant species`, 
    Cover_percentage = `cover (%)`, 
    Transect= transect,
    Plot=plot) %>%
  
  select(-notes)%>% #remove notes column
  #filter(Plant_sp != "no flowers")%>% #remove "no flowers" rows in Plant_sp col

  #rm NA in Site
  filter(!is.na(Site))

head(plants)
```

## 1.2. Standardize plant names

Using the Taxonomic Name Resolution Service (TNRS) to standardize plant names. The TNRS is a tool that helps to resolve and standardize taxonomic names by checking them against a database of known scientific names. This step ensures consistency in plant names and helps to avoid errors in downstream analyses. 

```{r standardize plant names TNRS, eval=FALSE, include=FALSE}
colnames(plants)
#next step requires internet connection
out_rom<- TNRS(taxonomic_names = plants$Plant_sp) # indicating where the scientific names to verify are
head(out_rom[,2:7])

to_correct <-out_rom %>% filter(Name_score < 1)
print(to_correct);length(to_correct$Name_score) #print the names that need to be corrected, in this case we have 0
#plants$plant<-gsub("previous name","correct name", plants$Plant_species) #replace the previous name with the correct name in a new column

#removing variables that are not needed for the next steps
rm(out_rom, to_correct)
```


## 1.3. Fixing Flower cover estimates (Braun-Blanquet cover abundance scale)

Indications written on the field sheets: 
- r = rare (1-3 individuals), cover up to 0.5% of the plot [0.1-0.5%]   
- +  = 3-5 individuals, cover up to 1% of the plot [0.5-1%]   
- 1 = many individuals (6 to 50 individuals), cover up to 5% of the plot [1-5%]   
- 2 = a lot (>50 individuals), cover up between 5 and 25% of the plot [5-25%]   
- 3 = very abundant, cover up to 50% of the plot [25-50%]   
- 4 = dominant, cover up to 75% of the plot [50-75%]   
- 5 = very dominant, cover up to 100% of the plot [75-100%]  

**Steps:**

1. A new column "BB" is created for the Braun-Blanquet scale. We first fill in the values that are already in the BB scale (+, r, 0, NA).
2. These same rows are emptied (NA) in the initial Cover_percentage column.
3. The Cover_percentage column is converted to numeric.
4. The empty BB values are filled based on the equivalent Cover_percentage values (as indicated above).
5. The remaining cells in Cover_percentage are still empty (NA), and filled with the equivalent BB values (r -> 0.3%, + -> 0.75%).
6. The BB column is converted to a factor with the levels in the correct order.
7. The new data frame is saved as "plants3".

```{r braun-blanquet}
#consistency in structure for cover_percentage
plants <- plants %>%
  #convert cover_percentage to character
  mutate(Cover_percentage = as.character(Cover_percentage)) %>%
  #transform "NA" to NA
  mutate(Cover_percentage = ifelse(Cover_percentage == "NA", NA, Cover_percentage))
    
#create a new column for BB scale and fill it
plants3 <- plants %>%
  #New column for BB scale where only "r", "+", 0 and NA are moved for now
  mutate(BB=case_when(
    Cover_percentage == "r" ~ "r",
    Cover_percentage == "+" ~ "+",
    Cover_percentage == "0" ~ "0",
    is.na(Cover_percentage) ~ NA_character_,
    #rest is empty for now
    TRUE ~ "")) %>%
  #remove "r", "+", 0 from Cover_percentage
  mutate(Cover_percentage = case_when(
    Cover_percentage == "r" ~ NA_character_,
    Cover_percentage == "+" ~ NA_character_,
    Cover_percentage == "0" ~ NA_character_,
    TRUE ~ Cover_percentage)) %>%
  #convert Cover_percentage to numeric
  mutate(Cover_percentage = as.numeric(Cover_percentage)) %>%
  #fill in the empty BB values based on BB scale
  mutate(BB = case_when(
    BB=="" & Cover_percentage <= 0.5 ~ "r",
    BB=="" & Cover_percentage < 1 ~ "+",
    BB=="" & Cover_percentage < 5 ~ "1",
    BB=="" & Cover_percentage < 25 ~ "2",
    BB=="" & Cover_percentage < 50 ~ "3",
    BB=="" & Cover_percentage < 75 ~ "4",
    TRUE ~ BB))

# fill in the NA values in Cover_percentage based on BB scale
plants3 <- plants3 %>%
  mutate(Cover_percentage = case_when(
    is.na(Cover_percentage) & BB == "r" ~ 0.3,
    is.na(Cover_percentage) & BB == "+" ~ 0.75,
    TRUE ~ Cover_percentage))%>%
  #BB as factor
  mutate(BB = factor(BB, levels = c("r", "+", "1", "2", "3", "4", "5")))
  
rm(plant_data_load, plants)
head(plants3)
```

Some rows (4) have "no flower" in the plant species column. 
These rows are true zeros that can't just be removed from the data set. 
We will replace them with a very common species for the Plant_sp column, with a 0 in the Cover_percentage column, and with a NA in the BB column. 

```{r fixing "no flower" rows}
# Replace "no flowers" with a common species name
plants3 <- plants3 %>%
  #if "no flower" in Plant_sp, put 0 in Cover_percentage and NA in BB
  mutate(Cover_percentage = ifelse(Plant_sp == "no flowers", 0, Cover_percentage),
         BB = ifelse(Plant_sp == "", NA, BB)) %>%
  #replace "no flowers" with a Daucus carota
  mutate(Plant_sp = ifelse(Plant_sp == "no flowers", "Daucus carota", Plant_sp))
```

```{r braun-blanquet plot}
#barplot of coverage per Site
ggplot(plants3, aes(x = Site, y = Cover_percentage, fill= Plant_sp)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(
    title = "Plant Species Coverage",
    x = "Site",
    y = "Cover Percentage (%)",
    fill = "Braun-Blanquet Scale"
  )+
  #remove legend
  theme(legend.position = "none")+
  # adding black outline to bars
  geom_bar(stat = "identity", color = "black")+
  #viridis color palette
  scale_fill_viridis(discrete = TRUE)
```

```{r save csv plants3 data}
# Save the cleaned plant data

# Save the wide and cleaned plant data
#write.csv(plants3, "C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/plants3.csv", row.names = FALSE)
```

# 2. Processing plant data

## A.1. NMDS - Average flower cover per site

```{r}
# NMDS analysis for plant species composition between the sites

# Create a community matrix
community_matrix <- plants3 %>%
  #remove "no flowers" rows in Plant_sp col
  #filter(Plant_sp != "no flowers") %>%
  #remove NA rows in Cover_percentage
  filter(!is.na(Cover_percentage)) %>%
  group_by(Site, Plant_sp) %>%
  summarise(Cover_percentage = mean(Cover_percentage), .groups = "drop") %>%
  pivot_wider(names_from = Plant_sp, values_from = Cover_percentage, values_fill = 0) %>%
  column_to_rownames(var = "Site") # Convert 'Site' column to row names

sum(is.na(community_matrix)) # Check for missing values
#transform into matrix
community_matrix <- as.matrix(community_matrix)

# Perform NMDS using Bray-Curtis distance
set.seed(123)
nmds_result <- metaMDS(community_matrix, distance = "bray", k = 2, trymax = 100)

# View results
print(nmds_result)

# Plot NMDS results
# Extract site scores for plotting
site_scores <- as.data.frame(scores(nmds_result, display = "sites"))
site_scores$Site <- rownames(site_scores)

# Create a vector indicating site type (restored vs. reference)
site_scores <- site_scores %>%
  mutate(Site_Type = ifelse(Site %in% c("WED", "KOT", "WDG", "BUH"), "Young Restored", "Reference"))

# Plot with customized colors
ggplot(site_scores, aes(x = NMDS1, y = NMDS2, color = Site_Type, label = Site)) +
  geom_point(size = 4, alpha = 0.8) + # Adjust alpha for transparency if needed
  geom_text(vjust = -0.5, size = 4) +
  scale_color_manual(values = steelorange) + # Apply custom colors
  geom_polygon(data = site_scores %>% 
                 group_by(Site_Type) %>%
                 slice(chull(NMDS1, NMDS2)), 
               aes(group = Site_Type, fill = Site_Type), 
               alpha = 0.3,show.legend = FALSE) + # Add convex hull  
  scale_fill_manual(values = steelorange) + # Apply fill colors to polygons
  theme_minimal() +
  labs(title = "NMDS of Plant Species Diversity by Site",
       x = "NMDS1",
       y = "NMDS2",
       color = "Site Type") # Update legend title
``` 

## A.2. PERMANOVA - Permutational Multivariate Analysis of Variance 

A PERMANOVA test allows us to determine whether plant species composition significantly differs between restored and reference sites. The test is based on a distance matrix (Bray-Curtis distance) calculated from the plant community matrix. It calculates the proportion of variance explained by the Site_Type variable and tests its significance using permutation tests. 

[https://en.wikipedia.org/wiki/Permutational_analysis_of_variance]
Permutational multivariate analysis of variance (PERMANOVA), is a non-parametric multivariate statistical permutation test. PERMANOVA is used to compare groups of objects and *test the null hypothesis that the centroids and dispersion of the groups as defined by measure space are equivalent for all groups*. A rejection of the null hypothesis means that either the centroid and/or the spread of the objects is different between the groups. 
```{r permanova}
# PERMANOVA to test for differences in plant species composition between restored and reference sites
permanova_result <- adonis2(community_matrix ~ Site_Type, data = site_scores, permutations = 999)

#glance at results
permanova_result
```

1. Degrees of Freedom (Df)

    Site_Type (1): This indicates one categorical predictor (Restored vs. Reference).
    Residual (7): This shows the remaining degrees of freedom after accounting for Site_Type.
    Total (8): The sum of all degrees of freedom in the model.

2. Sum of Squares (SumOfSqs)

    Site_Type (0.42033): The variation in species composition explained by site type.
    Residual (2.09368): The remaining variation not explained by site type.
    Total (2.51401): The total variance in the dataset.

3. R² (Proportion of Variation Explained)

    Site_Type (0.1672 or 16.72%): 16.72% of the total variation in plant composition is explained by site type.
    Residual (0.8328 or 83.28%): The rest (83.28%) is unexplained variation due to other factors.

4. F-Statistic (F)

    F = 1.4053: This is the ratio of explained to unexplained variance.
        A higher F-value suggests stronger group differences.

5. P-value (Pr(>F))

    P = 0.144: This means the difference is not statistically significant (p > 0.05).
        There is no strong evidence that plant composition differs significantly between site types.

* Final Interpretation

    Site type explains 16.72% of plant composition variation, but the p-value (0.144) suggests this difference is not statistically significant.
    This means that restored and reference sites do not have significantly different plant compositions based on this test.
        
        
## A.3. ANOSIM - Analysis of Similarities

ANOSIM (Analysis of Similarities) is a non-parametric test that compares the dissimilarity between groups to the dissimilarity within groups. It is similar to PERMANOVA but focuses on rank-based dissimilarities rather than variance.

```{r anosim}
# Compute Bray-Curtis distance matrix
bray_dist <- vegdist(community_matrix, method = "bray")

# Run ANOSIM
anosim_result <- anosim(bray_dist, site_scores$Site_Type)

# View ANOSIM results
summary(anosim_result)
plot(anosim_result)  # Visualize results
```
1. ANOSIM Statistic (R-value)

    R = 0.1625: This measures how separated the groups are.
        R values range from -1 to +1:
            R ≈ 1 → Strong separation between groups.
            R ≈ 0 → No meaningful difference between groups.
            R < 0 → More variation within groups than between groups (rare).
        In your case, R = 0.1625 is quite low, indicating only a weak difference in species composition between site types (Reference vs. Young Restored sites).

2. Significance (p-value)

    p = 0.19: This tells us whether the observed differences are statistically significant.
        p < 0.05 → Significant difference between groups.
        p > 0.05 → No strong evidence of a difference.
        Since p = 0.19, we fail to reject the null hypothesis, meaning there is no statistically significant difference between Reference and Young Restored sites.

3. Permutation Test Results

    The null model quantiles (90%, 95%, 97.5%, and 99%) show the expected R-values under random permutations.
        Your R (0.1625) is below the 90% quantile (0.231).
        This suggests that the observed differences could easily arise by chance.

4. Dissimilarity Ranks

    This section shows the rank distributions of dissimilarity values within and between groups.
        Between groups (Reference vs. Young Restored): Rank values range from 3 to 36.
        Within Reference sites: Rank values range from 1 to 35.
        Within Young Restored sites: Rank values range from 4 to 25.
        Since the dissimilarity ranks between groups (3–36) overlap considerably with those within groups, there is no strong separation.
        
## A.4. SIMPER Analysis - see plant drivers of composition differences (site_types)

```{r simper}
# Run SIMPER to compare plant composition between Site Types
simper_result <- simper(community_matrix, site_scores$Site_Type)

# View the summary of species contributions
summary(simper_result)

##plot simper results

# Convert SIMPER results into a tidy dataframe
simper_df <- data.frame(
  Species = names(simper_result[[1]]$average),  # Extract species names
  AvDiss = simper_result[[1]]$average,  # Average dissimilarity contribution
  Contrib = simper_result[[1]]$cusum,  # Cumulative contribution
  AvA = simper_result[[1]]$ava,  # Average cover in group A
  AvB = simper_result[[1]]$avb,  # Average cover in group B
  SD = simper_result[[1]]$sd,  # Standard deviation
  P_value = simper_result[[1]]$p  # P-values
)

# Sort by contribution
simper_df <- simper_df %>% arrange(desc(Contrib))

# View first few rows
head(simper_df)


# Bar plot of species contributions
ggplot(simper_df[1:10,], aes(x = reorder(Species, -Contrib), y = Contrib, fill = Contrib)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  coord_flip() +  # Flip for better readability
  labs(title = "Top 10 Species Driving Differences",
       x = "Species",
       y = "Contribution (%)") +
  theme_minimal()

# Cumulative contribution plot, reorder()
ggplot(simper_df, aes(x = reorder(Species, -Contrib), y = Contrib, fill = Contrib)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  coord_flip() +  # Flip for better readability
  labs(title = "Species Contribution to Dissimilarity",
       x = "Species",
       y = "Contribution (%)") +
  theme_minimal()

#scatter plot of average dissimilarity vs. contribution
ggplot(simper_df[54:69,], aes(x = AvDiss, y = Contrib, label = Species)) +
  geom_point(aes(color = Contrib), size = 3) +
  geom_text(vjust = 1.5, size = 3) +
  labs(title = "Species Contribution vs. Dissimilarity",
       x = "Average Dissimilarity",
       y = "Contribution (%)") +
  theme_minimal()

length(simper_df$Species) # 69 species in total
```

- Understanding SIMPER Output: Contribution % and Average Dissimilarity

SIMPER (Similarity Percentage Analysis) helps identify which species contribute the most to the difference between groups (e.g., Restored vs. Reference sites). It breaks down Bray-Curtis dissimilarity into individual species contributions.

1.  Average Dissimilarity (AvDiss)

    This value represents the average dissimilarity between the two groups.
    It tells you how different the species compositions are, on average, between sites.
    A higher AvDiss means the sites are more different in species composition.

2.  Contribution % (Contrib)

    This shows how much each species contributes to the total dissimilarity between groups.
    The sum of contributions for all species adds up to 100%.
    Higher contribution % = species is driving the difference between groups.

- Example:  

|Species |AvDiss  |Contrib %  |
|--------|--------|-----------|
|Daucus carota |0.12 |15.6% |
|Trifolium pratense |0.10 |12.8% |
|Lotus corniculatus |0.08 |10.2% |

    Daucus carota contributes 15.6% to the total difference between site types.
    The species with the highest Contrib % are the most important in differentiating the groups.

```{r}
#remove extra data
rm(simper_result, permanova_result, anosim_result, simper_df, site_scores)
```

## B. iNext Approach

## B.1. Hill number calculation (not pooled) - presence/absence at plot level 

*Species-by-sampling-unit matrix (like a checklist for each subplot)*

- plants1: Presence-absence matrix for each plant species in each plot
- Convert the flower cover percentage cover data to presence-absence data per plot (1 = present, 0 = absent). There were 5 transects per site, and each transect had three plots. 
- Replace NA values in the Cover_percentage column with 1 (presence), because since the species was written down, it means that it was present in the plot, but the cover % was forgotten/not written down properly. 
- Remove the "no flowers" rows in the Plant_sp column, as they do not contribute to species richness.
- Convert it to matrix format for iNEXT analysis
- Add top row with the total number of species per site in order to use  datatype = `'incidence_freq'`` 

- $AsyEst lists the observed diversity, asymptotic estimates, estimated bootstrap s.e. and 95% (default) confidence intervals for Hill numbers of order q = 0, 1, and 2. The estimated asymptotes are calculated via the functions ChaoRichness() for q=0, ChaoShannon() for q=1 and ChaoSimpson() for q=2; see Chao et al. (2014) for the formulas of these asymptotic estimators. [https://drive.google.com/file/d/1Z9T6xMD7IOSo1SqyF2BQou7Fez5evlhj/view] 
 
```{r preparing for iNEXT}
# Presence Absence transformation of Cover_percentage
plants1 <- plants3 %>%
  #transform plot column into factor
  mutate(Plot = factor(Plot))%>%
  #new presence/absence column
  mutate(Presence_Absence = ifelse(Cover_percentage > 0, 1, 0))%>%
  #Replace Na rows in Presence_Absence with 1 (presence)
  mutate(Presence_Absence = ifelse(is.na(Presence_Absence), 1, Presence_Absence))

plants1 <- as.data.frame(plants1)

# Create a matrix for iNEXT
matrix_plant <- create.matrix(x = plants1,
                                tax.name = 'Plant_sp',
                                locality = 'Site',
                                abund = TRUE,
                                abund.col = 'Presence_Absence')
#Check your work
identical(sum(matrix_plant),sum(plants1$Presence_Absence))
#both have 646 observations

# Convert to data.frame for use with iNEXT
matrix_plant <- as.data.frame(matrix_plant)

# Assign column names (site names)
colnames(matrix_plant) <- c("BUH", "DES", "HLI", "JEP", "KOT", "STP", "WDG", "WED", "WUP")

# Assign row names (species names) = unique and ordered plant species from Plant_sp column
rownames(matrix_plant) <- plants1$Plant_sp %>% unique() %>% sort()

# Define the number of sampling units per site 
total_units <- rep(15, ncol(matrix_plant))  # 15 plots per site

# Add as a new first row in the matrix
matrix_plant <- rbind(Total_units = total_units, matrix_plant)

# Print the updated matrix
head(matrix_plant)
```

```{r Hill number calculation}
#run iNEXT to get the diversity estimates per site
set.seed(2022);iNEXT_output_plants <- iNEXT(matrix_plant,
                                            q=c(0,1,2), 
                                            datatype = 'incidence_freq') #set seed for reproducibility, iNEXT include all three indices of diversity

# This are specifically the asymptotic diversity estimates with their confidence intervals: 
# iNEXT_output_plants$AsyEst 
#UCL = Upper Confidence Limit
#LCL = Lower Confidence Limit

#Plot the results and save the plot
(rarefaction_plant_sites <- ggiNEXT(iNEXT_output_plants, 
                                    type = 1, 
                                    color.var = 'Assemblage',
                                    facet.var="Order.q")+
  ggtitle("Plants: Rarefaction curves per site")+
  labs(y= "Flower species diversity", x="Number of plots")+
    #color options: custom_colors, pastel_colors and bicolor_palette, bicolor_bg
    scale_color_manual(values = custom_colors) + # Assign custom colors to sites (curves)
    scale_fill_manual(values = pastel_colors) + # Assign custom colors to sites (confidence intervals)
    scale_shape_manual(values = c(0, 1, 2, 3, 4, 5, 6, 7, 8))+  # Assign different shapes for each site
    theme_minimal()+
    theme(legend.position = "bottom")
  )

#ggsave("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/figures/rarefaction_plant_sites_q123.png")
```


```{r other iNext graphs, eval=FALSE, include=FALSE}
# Sample completeness curves
ggiNEXT(iNEXT_output_plants, type=2, color.var="Assemblage",facet.var="Order.q") +
  ylim(c(0.9,1)) +
  theme_bw(base_size = 18) +
  theme(legend.position="bottom") +
  ggtitle("Sample completeness curves for plant species") +
  labs(x="Number of plots", y="Sample completeness")+
  scale_color_manual(values = custom_colors) + # Assign custom colors to sites (curves)
  scale_fill_manual(values = pastel_colors) + # Assign custom colors to sites (confidence intervals)
  scale_shape_manual(values = c(0, 1, 2, 3, 4, 5, 6, 7, 8)) # Assign different shapes for each site

# Coverage-based R/E curves
ggiNEXT(iNEXT_output_plants, type=3, color.var ="Assemblage",facet.var="Order.q") +
  xlim(c(0.9,1)) +
  theme_bw(base_size = 18) +
  theme(legend.position="bottom",
  legend.title=element_blank(),
  text=element_text(size=18),
  legend.box = "vertical") +
  ggtitle("Coverage-based R/E curves for plant species") +
  labs(x="Coverage", y="R/E")+
  scale_color_manual(values = custom_colors) + # Assign custom colors to sites (curves)
  scale_fill_manual(values = pastel_colors) + # Assign custom colors to sites (confidence intervals)
  scale_shape_manual(values = c(0, 1, 2, 3, 4, 5, 6, 7, 8)) # Assign different shapes for each site
```

- `$iNextEst` for showing size- and coverage-based diversity estimates along with related statistics for a series of rarefied and extrapolated samples
- `$AsyEst` for showing asymptotic diversity estimates along with related statistics. 
- `$DataInfo`, as shown below, returns basic data information including the reference sample size (n), observed species richness (S.obs), sample coverage estimate for the reference sample (SC), and the first ten frequency counts (f1-f10)

```{r save iNext as csv, echo=FALSE}
# Check the data
#view(iNEXT_output_plants$iNextEst)
#head(iNEXT_output_plants[["iNextEst"]])
         

# Check the asymptotic estimates
#view(iNEXT_output_plants$AsyEst)

# Check the data information
#view(iNEXT_output_plants$DataInfo)

#save the AsyEst data as csv
write.csv(iNEXT_output_plants$AsyEst, "C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/iNext_AsyEst_plants.csv", row.names = FALSE)
```



## B.2. Hill number calculation (pooled) - presence/absence at plot level
- this time we are pooling all reference sites and all restored sites together to calculate the Hill numbers.
- The pooled analysis allows us to compare the overall diversity between the two groups of sites.

```{r preparing pooled data for iNEXT}
pooled <- plants3 %>%
  # New presence/absence column
  mutate(Presence_Absence = ifelse(Cover_percentage > 0, 1, 0)) %>%
  # Replace NA values in Presence_Absence with 1 (presence)
  mutate(Presence_Absence = replace_na(Presence_Absence, 1)) %>%
  # Group by Site_type and Plant_sp before summarizing
  group_by(Site_type, Plant_sp) %>%
  # Summarize presence/absence data
  summarise(Presence_Absence = sum(Presence_Absence), .groups = "drop") %>%
  # Rename "1-5 y" to "Young Restored"
  mutate(Site_type = ifelse(Site_type == "1-5 y", "Young Restored", Site_type))

# Create a matrix for iNEXT
pooled <- as.data.frame(pooled)
matrix_pooled <- create.matrix(x = pooled,
                                tax.name = 'Plant_sp',
                                locality = 'Site_type',
                                abund = TRUE,
                                abund.col = 'Presence_Absence')

#check your work
identical(sum(matrix_pooled),sum(pooled$Presence_Absence))
#they both have 652 observations

# Convert to data.frame for use with iNEXT
matrix_pooled <- as.data.frame(matrix_pooled)

# Assign column names (site_type names)
colnames(matrix_pooled) <- c("Reference", "Young Restored")

# Assign row names (species names) = unique and ordered plant species from Plant_sp column
rownames(matrix_pooled) <- pooled$Plant_sp %>% unique() %>% sort()

# Define the number of sampling units per site
total_units_pooled <- c(75,60)  # ref: 5 sites * 15 plots = 75 plots, restored: 4 sites * 15 plots = 60 plots

# Add as a new first row in the matrix
matrix_pooled <- rbind(Total_units = total_units_pooled, matrix_pooled)

# Print the updated matrix
head(matrix_pooled)
```


```{r Hill number calculation pooled}
#run iNEXT to get the diversity estimates for the pooled data
set.seed(2022);iNEXT_output_pooled <- iNEXT(matrix_pooled,   
                                            q=c(0,1,2), 
                                            datatype = 'incidence_freq') #set seed for reproducibility

#Plot the results and save the plot
(rarefaction_plant_pooled <- ggiNEXT(iNEXT_output_pooled, 
                                     type = 1, 
                                     color.var = 'Assemblage',
                                     facet.var="Order.q")+
  ggtitle("Plants: Rarefaction curves for pooled data")+
  labs(y= "Flower species diversity", x="Number of plots")+
    #scale_color_manual(values = bicolor_palette) + # Assign custom colors to sites (curves)
    #scale_fill_manual(values = bicolor_bg) + # Assign custom colors to sites (confidence intervals)
    #scale_shape_manual(values = c(0, 1, 2, 3, 4, 5, 6, 7, 8))+  # Assign different shapes for each site
    theme_minimal()+
    theme(legend.position = "bottom")
  )
```

```{r}
#remove all iNext data to clear up memory
rm(iNEXT_output_plants, matrix_plant, plants1)
rm(rarefaction_plant_sites, rarefaction_plant_pooled)
rm(matrix_pooled, iNEXT_output_pooled, pooled)
```


## C. Relative flower cover ratios

To have the relative cover ratios of each plant species per site, we need to calculate the total cover per site and then divide the cover of each species by the total cover.
$$\text{Relative cover ratio} = \frac{\text{Cover of species x per plot}}{\text{Total cover of all species per plot}}$$ 

To calculate the relative cover ratio per transect, we will average the relative cover ratios of each species across the three plots in each transect.

$$\text{Relative cover ratio of species x}_\text{per transect}=\frac{\text{relative_cov_%_plot}_{1}+\text{relative_cov_%_plot}_{2}+\text{relative_cov_%_plot}_{3}}{3}$$

```{r relative cover ratios}

# Calculate the total cover per site
relative_flower <- plants3 %>%
  select(-BB) %>%
  #remove NA in Cover_percentage
  filter(!is.na(Cover_percentage)) %>%
  #new column for total cover per site
  group_by(Site, Transect, Plot) %>%
  mutate(Plot_Cover = sum(Cover_percentage, na.rm = TRUE)) %>%
  #ungroup
  ungroup() %>%
  #new column for relative cover ratio
  mutate(Relative_cover_plot = Cover_percentage / Plot_Cover)%>%
  #replace NA in Relative_cover_plot with 0
  mutate(Relative_cover_plot = replace_na(Relative_cover_plot, 0))


relative_flower <- relative_flower %>%
group_by(Site, Site_type, Transect, Plant_sp) %>%
  mutate(Relative_cover_transect = sum(Relative_cover_plot, na.rm = TRUE) / 3) %>% # Average relative cover per species per transect
  ungroup()%>%
  select(-Plot,-Plot_Cover, -Relative_cover_plot, -Cover_percentage) %>%
  #keep only unique rows
  distinct()

# plot the relative cover ratios per species, reorder the species by average cover
ggplot(relative_flower, aes(x = reorder(Plant_sp, Relative_cover_transect), y = Relative_cover_transect, fill = Site)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(
    title = "Average Relative Cover Ratios per Species per Transect",
    x = "Plant Species",
    y = "Average Relative Cover Ratio",
    fill = "Site") +
  scale_fill_manual(values = custom_colors) +  # Apply custom colors to the plot
  theme(legend.position = "top")
```


## D. Gradient of plant diversity

### diversity index

```{r diversity index with relative cover}
# wide format for relative_flower
relative_flower_w <- relative_flower %>%
  tidyr::pivot_wider(names_from = Plant_sp, values_from = Relative_cover_transect, values_fill = 0)


# Calculate diversity indices with the vegan package - Simpson and Shannon indices
diversity_indices <- relative_flower_w %>%
  mutate(
    Floral_simpson_index = diversity(.[, -(1:3)], index = "simpson"),
    Floral_shannon_index = diversity(.[, -(1:3)], index = "shannon")
  ) %>%
  select(1:3, Floral_simpson_index, Floral_shannon_index
         )  # Keep only relevant columns

# Calculate species richness per transect
richness <- plants3 %>%
  group_by(Site, Transect) %>%
  summarise(Floral_species_richness = n_distinct(Plant_sp))

#join the diversity indices with the species richness data
diversity_indices <- left_join(diversity_indices, richness, by = c("Site", "Transect"))


#add the gradient of plant diversity to the relative_flower data (there will be repeated rows for those 3 new columns)
relative_flower <- left_join(relative_flower, diversity_indices, by = c("Site", "Transect", "Site_type"))

#remove the wide format data and the richness data
rm(relative_flower_w, richness)
```


### Plotting the diversity indices

```{r plot diversity indices}
#point plot the species richness per site
(sp <- ggplot(diversity_indices, aes(x = Site, y = Floral_species_richness, color = Site)) +
  geom_point(position = position_jitter(width = 0.1, height = 0),size = 3) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(
    title = "Plant Species Richness",
    x = "Site",
    y = "Number of Flower Species",
    color = "Site_type") +
  #change y limit to 0-30
  ylim(0, 30) +
  #custom colors
  scale_color_manual(values = custom_colors) +
  theme(legend.position = "none"))

#point plot the simpson index per site with jitter
(simp <-ggplot(diversity_indices, aes(x = Site, y = Floral_simpson_index, color = Site)) +
  geom_point(position = position_jitter(width = 0.1, height = 0), size = 3) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(
    title = "Simpson Div. Index",
    x = "Site",
    y = "Simpson Diversity Index",
    color = "Site_type") +
  #custom colors
  scale_color_manual(values = custom_colors) +
  theme(legend.position = "none"))

#point plot the shannon index per site with jitter
(shann <- ggplot(diversity_indices, aes(x = Site, y = Floral_shannon_index, color = Site)) +
  geom_point(position = position_jitter(width = 0.1, height = 0), size = 3) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(
    title = "Shannon Div. Index",
    x = "Site",
    y = "Shannon Diversity Index",
    color = "Site_type") +
  #custom colors
  scale_color_manual(values = custom_colors) +
  theme(legend.position = "none"))

#facet the 3 plots, add centered title for all plots, define image size and then save the plot
combined_plot <- sp + simp + shann + plot_annotation(title = "Relative Flower Diversity Metrics per Site",) & 
  theme(plot.title = element_text(hjust = 0.5, face = "bold", size = 16)) 
print(combined_plot)

ggsave("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/figures/diversity_metrics.png", width = 16, height = 8)

rm(sp, simp, shann, combined_plot)
```

```{r}
# Load pollinator interaction data
load("C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/20250120_netdata.RData")

# sum up of interactions per transect per flower species
pol <- net_data %>%
  select(Site=site, Transect=transect, Plant_sp = plant_species, total_interaction)%>%
  group_by(Site, Transect, Plant_sp) %>%
  summarise(total_interaction = sum(total_interaction, na.rm = TRUE)) 
  
# sum of interactions per transect (no flower species)
poli <- pol %>%
  select(-Plant_sp) %>%
  group_by(Site, Transect) %>%
  summarise(total_interaction = sum(total_interaction, na.rm = TRUE))

dim(diversity_indices)
dim(poli)

#add the diversity scores to the pollinator interaction data
pol_floral_diversity <- left_join(poli, diversity_indices, by = c("Site", "Transect"))

#scatterplot of Species richness vs. Total Interactions, custom colors for the sites
ggplot(pol_floral_diversity, aes(x = Floral_species_richness, y = total_interaction)) +
  geom_point(aes(color = Site)) +  # Apply the color based on Site
  geom_smooth(method = "lm", se = TRUE, color = "green4") +  # Add a linear regression line
  labs(title = "Plant Species Richness vs. Total Interactions",
       x = "Flower Species Richness",
       y = "Total Interactions") +
  theme_minimal() +
  scale_color_manual(values = custom_colors) +  # Apply the custom colors to the plot
  theme(legend.position = "bottom")

#remove outliers in total interactions
pol_div <- pol_floral_diversity %>%
  filter(total_interaction < 90)
#%>%filter(Floral_simpson_index > 0.1)

#scatterplot of Species richness vs. Total Interactions with 2 outliers removed, using custom colors for the sites

ggplot(pol_div, aes(x = Floral_species_richness, y = total_interaction)) +
  geom_point(aes(color = Site)) +
  geom_smooth(method = "lm", se = T, color = "green4") +
  labs(title = "Plant species Richness vs. Total Interactions",
       x = "Flower species Richness",
       y = "Total Interactions") +
  theme_minimal()+
  #adding colors to the point according to Site
  geom_point(aes(color = Site))+
  scale_color_manual(values = custom_colors) +  # Apply the custom colors to the plot
  theme(legend.position = "bottom")
  

## shannon

#scatterplot of Shannon Index vs. Total Interactions
ggplot(pol_floral_diversity, aes(x = Floral_shannon_index, y = total_interaction)) +
  geom_point(aes(color = Site)) +
  geom_smooth(method = "lm", se = T, color = "pink3") +
  labs(title = "Plant Shannon Index vs. Total Interactions",
       x = "Relative Flower Shannon Index",
       y = "Total Interactions") +
  theme_minimal()+
  #adding colors to the point according to Site
  geom_point(aes(color = Site))+
  scale_color_manual(values = custom_colors) +  # Apply the custom colors to the plot
  theme(legend.position = "bottom")

#scatterplot of Shannon Index vs. Total Interactions with 2 outliers removed
ggplot(pol_div, aes(x = Floral_shannon_index, y = total_interaction)) +
  geom_point(aes(color = Site)) +
  geom_smooth(method = "lm", se = T, color = "pink3") +
  labs(title = "Plant Shannon Index vs. Total Interactions",
       x = "Relative Flower Shannon Index",
       y = "Total Interactions") +
  theme_minimal()+
  #adding colors to the point according to Site
  geom_point(aes(color = Site))+
  scale_color_manual(values = custom_colors) +  # Apply the custom colors to the plot
  theme(legend.position = "bottom")

## simpson

#scatterplot of Simpson Index vs. Total Interactions
ggplot(pol_floral_diversity, aes(x = Floral_simpson_index, y = total_interaction)) +
  geom_point(aes(color = Site)) +
  geom_smooth(method = "lm", se = T, color = "blue") +
  labs(title = "Plant Simpson Index vs. Total Interactions",
       x = "Relative Flower Simpson Index",
       y = "Total Interactions") +
  theme_minimal()+
  #adding colors to the point according to Site
  geom_point(aes(color = Site))+
  scale_color_manual(values = custom_colors) +  # Apply the custom colors to the plot
  theme(legend.position = "bottom")

#scatterplot of Simpson Index vs. Total Interactions with 2 outliers removed
ggplot(pol_div, aes(x = Floral_simpson_index, y = total_interaction)) +
  geom_point(aes(color = Site)) +
  geom_smooth(method = "lm", se = T, color = "blue") +
  labs(title = "Plant Simpson Index vs. Total Interactions",
       x = "Relative Flower Simpson Index",
       y = "Total Interactions") +
  theme_minimal()+
  #adding colors to the point according to Site
  geom_point(aes(color = Site))+
  scale_color_manual(values = custom_colors) +  # Apply the custom colors to the plot
  theme(legend.position = "bottom")
```






## E. Aggregate plant data and pollinator interaction data

```{r relative cover summary}
combined_data <- full_join(relative_flower, 
                           pol, 
                           by = c("Site", "Transect", "Plant_sp")) # to keep all plant species from both flower_cover_summary and pol

#replace introduced NA values with 0
combined_data$total_interaction[is.na(combined_data$total_interaction)] <- 0
combined_data$Relative_cover_transect[is.na(combined_data$Relative_cover_transect)] <- 0

length(unique(combined_data$Plant_sp)) # 74

summary(combined_data)

#compare total plant species in plants3 and pol
length(unique(plants3$Plant_sp)) # 70
length(unique(pol$Plant_sp)) # 40

#fill in the missing diversity indices with the values found in the same Site and Transect, eg. if there is a missing value in Floral_species_richness WED T1, fill it with the value found in other rows with WED T1
combined_data <- combined_data %>%
  group_by(Site, Transect) %>%
  fill(Floral_species_richness, Floral_simpson_index, Floral_shannon_index, .direction = "downup") %>%
  ungroup()


```

```{r visualizing combined data}
#remove all rows with 0 interactions
#combined_data <- combined_data %>%
#  filter(total_interaction > 0)

## Relationship between flower abundance (cover %) and pollinator interactions ----------------------------

ggplot(combined_data, aes(x = Relative_cover_transect, y = total_interaction)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  labs(title = "Flower Cover vs. Pollinator Interactions (1 point = 1 transect)",
       x = "Average Flower Cover (%)",
       y = "Number of Pollinator Interactions") +
  theme_minimal()+
  ylim(0, 60)+
  #adding colors to the point according to Site
  geom_point(aes(color = Plant_sp))+
  scale_color_viridis(discrete = TRUE)+
  
  #remove legend
  theme(legend.position = "none")

cor_test <- cor.test(combined_data$Relative_cover_transect, combined_data$total_interaction)
print(cor_test)
```

### most pollinator visited plant species

```{r}
# Pollinator Interaction Distribution
ggplot(combined_data, aes(x = total_interaction)) +
  geom_histogram(binwidth = 2, fill = "red", alpha = 0.5) +
  labs(title = "Distribution of Pollinator Interactions per Flower Species", x = "Number of Interactions", y = "Count") +
  theme_minimal()

# find out which plant species are the most visited by pollinators
top_plants <- combined_data %>%
  #remove outliers in total interactions per transect
  filter(total_interaction < 80) %>%
  group_by(Plant_sp) %>%
  summarise(total_interactions = sum(total_interaction, na.rm = TRUE)) %>%
  arrange(desc(total_interactions)) %>%
  head(10)
  
#plot the top 10 plant species
ggplot(top_plants, aes(x = reorder(Plant_sp, total_interactions), y = total_interactions)) +
  geom_bar(stat = "identity", fill = "pink") +
  labs(title = "Top 10 Most Visited Plant Species by Pollinators",
       x = "Plant Species",
       y = "Total Interactions") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```

### abundance of the 2 most visited plant species

```{r top2}
top2 <- relative_flower%>%
  #keep only rows that are top 2 plant species: Daucus carota, Pastinaca sativa
  filter(Plant_sp %in% c("Daucus carota", "Pastinaca sativa")) %>%
  #make wider with Plant_sp as column names
  pivot_wider(names_from = Plant_sp, values_from = Relative_cover_transect, values_fill = 0) %>%
  #add the percentages of the 2 plant species into a column named top2_ratio
  rowwise() %>%
  mutate(top2_ratio = sum(c(`Daucus carota`, `Pastinaca sativa`)))
```

```{r save relative_flower and top2 as csv}
#save the relative_flower and top2 data as csv
write.csv(relative_flower, "C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/relative_flower.csv", row.names = FALSE)
write.csv(top2, "C:/Users/Almas/Desktop/UNI_LEIPSI/Thesis/Thesis_Rproject/data/top2.csv", row.names = FALSE)
```


# F. Network Metrics
```{r packages}
library(bootstrapnet)
library (devtools)
library(cli)
library(bootstrapnet)

library(bipartite)
library(magrittr)
library(readxl)
```

```{r read data}
# Prepare data into plant-pollinator matrices and store them in a list.
colnames(net_data)
net_data <- net_data %>%
  #change lowest_taxa to "Family: Coccinellidae" for all rows where Family column is Coccinellidae
  mutate(lowest_taxa = ifelse(family == "Coccinellidae", "Family: Coccinellidae", lowest_taxa)) %>%
  select(site, site_type, transect, plant_species, lowest_taxa, total_interaction) %>%
  rename(Site = site, Site_type=site_type, Transect = transect, Plant_sp = plant_species, Lowest_taxa = lowest_taxa, Total_interaction = total_interaction)
  
# Prepare data into plant-pollinator matrices and store them in a list.
list_of_webs <- frame2webs(dframe = net_data,
                           varnames = c('Plant_sp',   # column with lower trophic level (plants)
                                        'Lowest_taxa',  # column with higher trophic level (butterflies)
                                        'Site_type',     # column with the type of meadow on which interactions were observed
                                        'Total_interaction')) # column with number of times an interaction was observed
```

### Network plots

The matrix plot shows where the interactions plant-insects are and if using square="interaction" can also show how strong interactions are using levels of gray (white means no interaction). 


```{r network plots, eval=FALSE, include=FALSE}
# Bipartite interaction plot for reference sites
plotweb(list_of_webs$reference,
        method = "cca",
        labsize = 1.5,
        text.rot = 90,
        y.width.low = 0.01,
        y.width.high = 0.01,
        arrow = "no",
        high.y = 1.2,
        low.y = 0.6)+
  title("Bipartite Interaction Plot for Reference Sites")

# Bipartite interaction plot for restored sites
plotweb(list_of_webs$young_restored,
        method = "cca",
        labsize = 1.5,
        text.rot = 90,
        y.width.low = 0.01,
        y.width.high = 0.01,
        arrow = "no",
        high.y = 1.2,
        low.y = 0.6)+
  title("Bipartite Interaction Plot for Restored Sites")

```

### Network Metrics

- H2 
  + is a network-level measure of specialization. It ranges between 0 (no specialization) and 1 (complete specialization).More specifically, H2' is a measure of discrimination, i.e. calculated in comparison to no specialization. [https://www.rdocumentation.org/packages/bipartite/versions/2.19/topics/networklevel]
  + characterizes the degree of specialization or partitioning among two parties in the entire network, H2 is not affected by network size or sampling intensity [https://bmcecol.biomedcentral.com/articles/10.1186/1472-6785-6-9]

```{r network metrics, eval=FALSE, include=FALSE, echo=FALSE}
# H2 --------------------------------------------------
# Reference sites
# print message: "Calculating network metrics for reference sites..."
print("H2 reference sites:");
networklevel(web = list_of_webs$reference, index = "H2")

# Restored sites
print("H2 restored sites:");
networklevel(web = list_of_webs$young_restored, index = "H2")


# Nestedness --------------------------------------------------

# Reference sites
print("Nestedness reference sites:");
set.seed(2024);
networklevel(web = list_of_webs$reference, index = "nestedness")

# Restored sites
print("Nestedness restored sites:");
set.seed(2024);
networklevel(web = list_of_webs$young_restored, index = "nestedness")

# All network indices -----------------------------------------

# Compute all the network indices for reference sites.
print("Reference sites:");
set.seed(2024);
networklevel(web = list_of_webs$reference, index = "ALLBUTDD") # or do not specify index at all

# Compute all the network indices for restored sites.
print("Restored sites:");
set.seed(2024);
networklevel(web = list_of_webs$young_restored, index = "ALLBUTDD") # or do not specify index at all

```
```{r bootstrap for network metrics} 
bootstraps_con = list_of_webs %>%
  lapply(web_matrix_to_df) %>%
  boot_networklevel(col_lower = "lower",
                    col_higher = "higher",
                    level = "both",
                    index = "H2",
                    start = 10,
                    step = 10,
                    n_boot = 100,
                    n_cpu = 2)

gg_networklevel(bootstraps_con)
  
```



### NMDS for netted lowest_taxa pollinators
```{r eval=FALSE, include=FALSE}
# Create a community matrix for pollinators
community_matrix_pollinators <- net_data %>%
  select(Site,Site_type, Transect, Lowest_taxa, Total_interaction) %>%
  group_by(Site, Lowest_taxa) %>%
  summarise(Total_interaction = sum(Total_interaction, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = Lowest_taxa, values_from = Total_interaction, values_fill = 0) %>%
  column_to_rownames(var = "Site") # Convert 'Site' column to row names


sum(is.na(community_matrix_pollinators)) # Check for missing values
#transform into matrix
community_matrix_pollinators <- as.matrix(community_matrix_pollinators)

# Perform NMDS using Bray-Curtis distance
set.seed(123);
nmds_result_pol <- metaMDS(community_matrix_pollinators, distance = "bray", k = 2, trymax = 100)

# View results
print(nmds_result_pol)

# Plot NMDS results
# Extract site scores for plotting
site_scores_pol <- as.data.frame(scores(nmds_result_pol, display = "sites"))
site_scores_pol$Site <- rownames(site_scores_pol)

# Create a scatterplot
ggplot(site_scores_pol, aes(x = NMDS1, y = NMDS2, label = Site)) +
  geom_point(size = 3, color = "blue") +
  geom_text(vjust = -0.5, size = 4) +
  theme_minimal() +
  labs(title = "NMDS of Pollinator Lowest_taxa Diversity by Site",
       x = "NMDS1",
       y = "NMDS2")


# Create a vector indicating site type (restored vs. reference)
site_scores_pol <- site_scores_pol %>%
  mutate(Site_Type = ifelse(Site %in% c("WED", "KOT", "WDG", "BUH"), "Young Restored", "Reference"))

# Plot with customized colors
ggplot(site_scores_pol, aes(x = NMDS1, y = NMDS2, color = Site_Type, label = Site)) +
  geom_point(size = 4, alpha = 0.8) + # Adjust alpha for transparency if needed
  geom_text(vjust = -0.5, size = 4) +
  scale_color_manual(values = custom_colors) + # Apply custom colors
  geom_polygon(data = site_scores_pol %>% 
                 group_by(Site_Type) %>%
                 slice(chull(NMDS1, NMDS2)), 
               aes(group = Site_Type, fill = Site_Type), 
               alpha = 0.3,show.legend = FALSE) + # Add convex hull  
  scale_fill_manual(values = steelorange) + # Apply fill colors to polygons
  theme_minimal() +
  labs(title = "NMDS of Pollinator lowest_taxa Diversity by Site",
       x = "NMDS1",
       y = "NMDS2",
       color = "Site Type") # Update legend title

```

